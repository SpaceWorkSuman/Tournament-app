
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tournament App</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!-- NEW: Chart.js library for performance graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-bg: #1a103c;
            --secondary-bg: #3a295b;
            --accent-green: #1fbf73;
            --accent-red: #e94254;
            --text-primary: #ffffff;
            --text-secondary: #c0b8d8;
            --text-tertiary: #8e85a9;
            --coin-gold: #ffc107;
            --chat-sent-bg: #005c4b;
            --body-bg: #0d1222;
            --skeleton-gradient: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.08), transparent);
            --card-overlay-1: rgba(0,0,0,0.65);
            --card-overlay-2: rgba(0,0,0,0.85);
            --custom-card-overlay-1: rgba(0,0,0,0.65);
            --custom-card-overlay-2: rgba(0,0,0,0.85);
            --tab-border-color: #4a3a6b;
            --inspect-modal-header-bg: linear-gradient(135deg, #3a295b, #2c1f4a);
            --inspect-modal-body-bg: #2c1f4a;
            --likes-badge-bg: rgba(0,0,0,0.5);
            --likes-badge-border: rgba(255,255,255,0.2);
            --likes-badge-text: var(--text-primary);
            --button-main-bg: var(--accent-green);
            --button-main-text: white;
            --button-gold-bg: #ffc107; 
            --button-gold-text: #222; 
            --button-secondary-bg: rgba(255,255,255,0.1);
            --button-secondary-text: var(--text-secondary);
            --button-red-bg: var(--accent-red);
            --button-red-text: white;
        }
        html[data-theme="amoled"] {
            --primary-bg: #000000;
            --secondary-bg: #1c1c1e;
            --text-primary: #e0e0e0;
            --text-secondary: #a0a0a0;
            --text-tertiary: #707070;
            --body-bg: #000000;
            --tab-border-color: #2a2a2c;
            --inspect-modal-header-bg: linear-gradient(135deg, #1c1c1e, #111);
            --inspect-modal-body-bg: #111;
            --likes-badge-bg: rgba(0,0,0,0.6);
            --likes-badge-border: rgba(255,255,255,0.1);
            --button-main-bg: #1fbf73;
            --button-gold-bg: #e0b000;
            --button-gold-text: #222;
        }
        html[data-theme="light"] {
            --primary-bg: #f0f2f5;
            --secondary-bg: #ffffff;
            --text-primary: #1c2a48;
            --text-secondary: #555555;
            --text-tertiary: #777777;
            --coin-gold: #ffa000;
            --body-bg: #e9ebee;
            --tab-border-color: #ddd;
            --inspect-modal-header-bg: linear-gradient(135deg, #f0f2f5, #e9ebee);
            --inspect-modal-body-bg: #fff;
            --likes-badge-bg: #ffffff;
            --likes-badge-border: #e0e0e0;
            --likes-badge-text: var(--text-secondary); 
            --button-main-bg: #1fbf73;
            --button-main-text: white;
            --button-gold-bg: #ffa000;
            --button-gold-text: #4A3B00;
            --button-secondary-bg: #e0e0e0;
            --button-secondary-text: var(--text-secondary);
            --button-red-bg: #e94254;
            --button-red-text: white;
        }
        html[data-theme="gold-black"] {
            --primary-bg: #0a0a0a;
            --secondary-bg: #1a1a1a;
            --accent-green: #ffc107;
            --accent-red: #e94254;
            --text-primary: #e0e0e0;
            --text-secondary: #a0a0a0;
            --text-tertiary: #707070;
            --coin-gold: #ffc107;
            --body-bg: #000000;
            --tab-border-color: #333;
            --inspect-modal-header-bg: linear-gradient(135deg, #1f1f1f, #111);
            --inspect-modal-body-bg: #111;
            --likes-badge-bg: rgba(0,0,0,0.6);
            --likes-badge-border: rgba(255,255,255,0.1);
            --likes-badge-text: #ffffff;
            --button-main-bg: var(--coin-gold); 
            --button-main-text: #222;
            --button-gold-bg: var(--coin-gold);
            --button-gold-text: #222;
            --button-secondary-bg: rgba(255,255,255,0.15);
            --button-secondary-text: var(--text-secondary);
            --button-red-bg: var(--accent-red);
            --button-red-text: white;
        }
        
        /* Referral Banner specific styling */
        .referral-banner {
             background: linear-gradient(135deg, #ffb347, #ffcc33);
             color: #4A3B00;
        }
        .referral-banner .banner-btn {
            background-color: #fff;
            color: #4A3B00;
        }
        .referral-banner h3, .referral-banner p {
            color: #4A3B00;
            text-shadow: 1px 1px 2px rgba(255,255,255,0.2);
        }

        *{margin:0;padding:0;box-sizing:border-box;}
        html { font-size: 14px; }
        body { font-family:'Poppins',sans-serif; background-color: var(--body-bg); color:var(--text-primary); height: 100vh; overflow: hidden; }
        .hidden{display:none !important;}
        
        .user-badge { width: 12px; height: 12px; vertical-align: middle; margin-left: 4px; }
        .player-pill-list { display: flex; flex-wrap: wrap; gap: 4px; }
        .player-pill { background-color: rgba(0,0,0,0.3); color: var(--text-secondary); font-size: 0.7rem; padding: 2px 6px; border-radius: 10px; }
        
        #auth-wrapper{display:flex;justify-content:center;align-items:center;height:100%;}
        .auth-form-container{width:100%;max-width:450px;margin:20px;}
        .auth-form-card{background-color:white;color:#333;border-radius:25px;padding:30px 35px;text-align:center;}
        .auth-form-card h1{font-size:2rem;margin-bottom:30px;color:#1c2a48;}
        .auth-form-group{margin-bottom:20px;text-align:left;}
        .auth-form-group input{width:100%;padding:12px 15px;border:1px solid #ddd;border-radius:10px;font-size:1rem;}
        .auth-submit-btn{width:100%;padding:15px;background-color:#1c2a48;color:white;border:none;border-radius:50px;font-size:1.1rem;font-weight:600;cursor:pointer; transition: transform 0.1s ease;}
        .auth-submit-btn:active { transform: scale(0.98); }
        .auth-toggle-link-p{margin-top:30px;font-size:0.9rem;}
        .auth-toggle-link{color:#1c2a48;font-weight:700;cursor:pointer;}
        .auth-message{margin-top:20px;font-weight:600;padding:10px;border-radius:5px;display:none;}
        .message-success{color:#155724;background-color:#d4edda;border:1px solid #c3e6cb;display:block !important;}
        .message-error{color:#721c24;background-color:#f8d7da;border:1px solid #f5c6cb;display:block !important;}
        .message-warning{color:#856404;background-color:#fff3cd;border:1px solid #ffeeba;display:block !important;}
        #app-wrapper{display:flex;justify-content:center;height:100vh;}
        .app-container{width:100%;max-width:600px;display:flex;flex-direction:column;background-color:var(--primary-bg);position:relative;overflow:hidden;}
        .app-header { display: flex; justify-content: space-between; align-items: center; padding: 6px 10px; background-color: var(--primary-bg); position: relative; z-index: 10; gap: 10px; }
        .header-left { display: flex; align-items: center; gap: 5px; min-width: 0; flex: 1; }
        .header-title { font-size: 1.1rem; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .header-right { display: flex; align-items: center; gap: 15px; flex-shrink: 0; }
        #notification-btn { cursor: pointer; position: relative; }
        .notification-dot { position: absolute; top: -2px; right: -2px; width: 8px; height: 8px; background-color: var(--accent-red); border-radius: 50%; border: 1px solid var(--secondary-bg); }
        .wallet { background-color: rgba(0,0,0,0.2); padding: 4px 10px; border-radius: 20px; display: flex; align-items: center; gap: 5px; font-weight: 600; font-size: 0.9rem; cursor: pointer; max-width: 120px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .wallet .material-icons{color:var(--accent-green);font-size:18px;}

        #streak-container {
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
            color: var(--text-secondary);
            background-color: rgba(0,0,0,0.2);
            padding: 4px 8px;
            border-radius: 20px;
        }
        #streak-container .material-icons {
            color: #ff9f43; /* Orange fire color */
            font-size: 18px;
        }
        #streak-count {
            font-weight: 600;
            font-size: 0.9rem;
        }

        main{flex-grow:1;overflow-y:auto;position:relative;}
        .page{display:none;height:100%;flex-direction:column;}
        .page.active{display:flex; animation: page-in 0.4s ease-out;}
        #profile-page.active { display: grid; }
        @keyframes page-in { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        #profile-page {
            gap: 15px;
            padding: 15px;
            grid-template-columns: 1fr;
        }
        .profile-header-card, .game-ids-section, .profile-stats-grid, .profile-page-actions, .profile-performance-section {
            background-color: var(--secondary-bg);
            border-radius: 15px;
            padding: 15px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        .profile-header-card, .game-ids-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }
        .profile-header-card { position: relative; }

        .profile-stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            padding: 12px 15px;
            align-items: stretch;
        }
        .profile-stats-grid .stat-box {
            background-color: var(--primary-bg);
            height: 60%; 
            justify-content: center;
            display: flex;
            flex-direction: column;
        }
        #profile-logout-btn-header, #profile-settings-btn-header { position: absolute; top: 10px; background: rgba(0,0,0,0.2); color: var(--text-tertiary); border:none; border-radius: 50%; padding: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: background-color 0.2s; }
        #profile-logout-btn-header:hover, #profile-settings-btn-header:hover { background-color: rgba(0,0,0,0.4); }
        #profile-logout-btn-header { right: 10px; }
        #profile-settings-btn-header { right: 50px; }
        #profile-logout-btn-header .material-icons, #profile-settings-btn-header .material-icons { font-size: 20px; }
        .profile-pic-container { position: relative; display: inline-block; margin-bottom: 2px;}
        #my-profile-likes-display-container {
            position: absolute;
            top: 2px; 
            right: 130px; 
            background-color: var(--likes-badge-bg);
            color: var(--likes-badge-text);
            padding: 3px 6px; 
            border-radius: 15px;
            z-index: 1;
            border: 1px solid var(--likes-badge-border);
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            white-space: nowrap; 
            font-size: 0.7rem; 
            display: flex; 
            align-items: center;
            gap: 3px; 
        }
        #my-profile-likes-display {
            font-size: 0.7rem; 
            display: flex;
            align-items: center;
            gap: 3px;
        }
        .profile-pic { width: 90px; height: 90px; border-radius: 50%; object-fit: cover; border: 3px solid var(--accent-green); }
        #pfp-upload { display: none; }
        .profile-name { font-size: 1.4rem; font-weight: 600; margin-top: 2px; word-break: break-all; display: inline-flex; align-items: center; justify-content: center; flex-wrap: wrap; }
        .profile-bio { color: var(--text-secondary); margin-top: 3px; font-size: 0.85rem; line-height: 1.4; min-height: 18px; word-break: break-all; }
        #edit-bio-btn { background: rgba(255,255,255,0.1); border-radius: 50%; padding: 4px; font-size: 0.9rem; margin-left: 6px; vertical-align: middle; color: var(--accent-green); cursor:pointer; border:none; }
        .referral-box { background: rgba(0,0,0,0.2); padding: 8px 10px; border-radius: 8px; margin-top: 10px; display: flex; justify-content: space-between; align-items: center; width: 100%; }
        #referral-code { font-weight: 600; letter-spacing: 1.5px; color: var(--coin-gold); font-size:0.9rem; }
        #copy-ref-btn { background:none;border:none;color:var(--text-secondary);cursor:pointer;font-size:18px; }
        .game-ids-section { overflow: hidden; }
        .game-id-content { padding: 0; width: 100%; }
        .game-id-content .form-group { margin-bottom: 12px; }
        .game-id-content label { font-size: 0.7rem; color: var(--text-tertiary); display: block; margin-bottom: 4px; text-align:left; }
        .game-id-content input { background: var(--primary-bg); border: 1px solid var(--tab-border-color); color: var(--text-primary); padding: 8px 10px; border-radius: 8px; font-size:0.9rem; width:100%; display:block; }
        #profile-save-btn, .action-btn, .join-btn { transition: transform 0.1s ease; }
        #profile-save-btn:active, .action-btn:active, .join-btn:active { transform: scale(0.97); }
        #profile-save-btn { width: 100%; margin-top:5px; background: var(--button-main-bg); color: var(--button-main-text); border: none; padding: 9px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 0.9rem; }
        .stat-box { background: var(--primary-bg); border-radius: 10px; padding: 12px 10px; text-align: center; }
        .stat-box .value { font-size: 1.4rem; }
        .stat-box .label { font-size: 0.75rem; margin-top: 4px; }
        .profile-page-actions { display: flex; flex-direction: column; gap: 10px; width: 100%; padding: 0;}
        #game-rules-btn { background-color: var(--button-secondary-bg); padding: 9px; border-radius: 8px; font-size: 0.9rem; font-weight: 600; cursor: pointer; color:var(--button-secondary-text); border:1px solid var(--tab-border-color); width:100%;}
        .like-btn-golden {
            background: var(--button-gold-bg);
            color: var(--button-gold-text);
            border: 1px solid var(--coin-gold);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            padding: 7px 15px;
            font-weight: 600;
            transition: transform 0.1s ease, box-shadow 0.2s ease;
            font-size:0.85rem;
            border-radius: 25px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        .like-btn-golden:active { transform: scale(0.95); } 
        .profile-likes-golden { font-weight: 600; color: var(--coin-gold); display: inline-flex; align-items: center; justify-content: center; gap: 6px; font-size: 0.8rem; }
        .material-icons {
            font-family: 'Material Icons';
            font-weight: normal;
            font-style: normal;
            font-size: 1.1em;
            display: inline-block;
            line-height: 1;
            text-transform: none;
            letter-spacing: normal;
            word-wrap: normal;
            white-space: nowrap;
            direction: ltr;
            -webkit-font-smoothing: antialiased;
            text-rendering: optimizeLegibility;
            -moz-osx-font-smoothing: grayscale;
            font-feature-settings: 'liga';
            vertical-align: middle;
        }
        .profile-likes-golden .material-icons { color: var(--coin-gold); }
        #leaderboard-page h2 { text-align:center; padding: 15px 15px 0; color:var(--text-primary); background-color: var(--primary-bg); margin:0; position: sticky; top: 0; z-index: 11; }
        .leaderboard-list {flex-grow:1; overflow-y:auto; padding:10px; display: flex; flex-direction: column; gap: 8px;}
        .leaderboard-item { display: flex; align-items: center; background-color: var(--secondary-bg); padding: 8px 12px; border-radius: 10px; gap: 12px; }
        .leaderboard-item .rank { font-size: 1.1rem; font-weight: 700; color: var(--coin-gold); min-width: 30px; text-align: center; }
        .leaderboard-item .profile-pic-small { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; cursor:pointer;}
        .leaderboard-item .info { flex-grow: 1; cursor:pointer; display: flex; flex-direction: column; justify-content: center; min-width:0;}
        .leaderboard-item .info .name-line { display: flex; align-items: center; }
        .leaderboard-item .info .name { font-weight: 600; font-size: 0.9rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .leaderboard-item .info .winnings-text { font-size: 0.75rem; color: var(--text-secondary); }
        .leaderboard-item .winnings-value { font-weight: 600; font-size: 0.95rem; color: var(--accent-green); display:flex; align-items:center; gap: 4px; white-space: nowrap; margin-left: auto; padding-left: 10px;}
        .leaderboard-item .winnings-value .material-icons { font-size: 14px; color: var(--coin-gold); }
        #user-inspect-modal .modal-content { background-color: transparent; max-width: 250px; padding:0; border-radius:15px; box-shadow: 0 5px 20px rgba(0,0,0,0.3);}
        #user-inspect-modal .inspect-header { padding: 15px; position:relative; background: var(--inspect-modal-header-bg); border-top-left-radius: 18px; border-top-right-radius: 18px; padding-bottom: 45px; text-align: center; }
        #user-inspect-modal .modal-close-btn {top:10px; right:12px; color:var(--text-primary); font-size:1.5rem; z-index: 2; background-color: rgba(0,0,0,0.2); border-radius: 50%; width: 30px; height: 30px; display:flex; align-items:center; justify-content:center;}
        #user-inspect-modal .inspect-pic-container { position: absolute; bottom: -40px; left: 50%; transform: translateX(-50%); }
        #user-inspect-modal #inspect-profile-pic { width: 80px; height: 80px; border-radius: 50%; border: 4px solid var(--inspect-modal-body-bg); }
        #user-inspect-modal .modal-body { padding: 55px 20px 20px; text-align:center; background: var(--inspect-modal-body-bg); border-bottom-left-radius: 18px; border-bottom-right-radius: 18px;}
        #user-inspect-modal #inspect-profile-name { font-size: 1.25rem; margin:0; word-break:break-word; color:var(--text-primary); font-weight:600; display: inline-flex; align-items: center;}
        #user-inspect-modal #inspect-profile-bio { font-size: 0.8rem; color: var(--text-secondary); margin:5px 0 15px; min-height:18px; max-height: 45px; overflow-y:auto; line-height:1.4;}
        #user-inspect-modal #inspect-profile-stats { display:flex; justify-content:center; align-items:center; margin-bottom:18px; font-size:0.85rem; }
        #user-inspect-modal #inspect-profile-actions { display: flex; flex-direction: column; gap: 10px; }
        #user-inspect-modal #inspect-profile-actions .action-btn { width:100%; font-size:0.9rem; padding: 9px 15px; border-radius:25px; transition: transform 0.1s ease; }
        #user-inspect-modal #inspect-profile-actions .action-btn:active { transform: scale(0.98); }
        #user-inspect-modal #inspect-view-full-profile-btn { background-color: var(--button-secondary-bg); color:var(--button-secondary-text); border:1px solid var(--tab-border-color); }
        #user-inspect-modal #inspect-profile-likes .material-icons { font-size: 1em; margin-right:3px; }
        .button-style-tabs { display: flex; background-color: var(--primary-bg); position: sticky; z-index: 10; border-bottom: 1px solid var(--tab-border-color); }
        .button-style-tabs a { flex: 1; padding: 10px 8px; color: var(--text-tertiary); text-align: center; text-decoration: none; font-weight: 500; font-size: 0.85rem; cursor: pointer; transition: background-color 0.2s ease, color 0.2s ease, border-bottom-color 0.2s ease, box-shadow 0.2s ease; border-bottom: 3px solid transparent; position: relative; margin-bottom: -1px; }
        .button-style-tabs a:hover { color: var(--text-primary); background-color: rgba(255,255,255,0.05); }
        .button-style-tabs a.active { background-color: var(--secondary-bg); color: var(--accent-green); font-weight: 600; border-bottom-color: var(--accent-green); box-shadow: 0 -2px 5px rgba(0,0,0,0.1) inset; }
        #game-type-tabs { top: 0; }
        #match-status-tabs { top: 50px; }
        #custom-match-main-tabs { top: 0; }
        #custom-match-main-tabs a { font-size: 0.8rem; padding: 8px 8px; }
        .tabs { border-bottom: none; }
        .tournament-list, .history-list, .transaction-history-list { padding: 0; flex-grow:1; overflow-y:auto; }
        #available-custom-matches-list, #my-challenges-list { display: flex; flex-direction: column; gap: 12px; }
        .tournament-card, .custom-match-card { background-color: var(--secondary-bg); border-radius: 10px; padding: 10px; opacity: 0; transform: translateY(20px) scale(0.98); animation: card-in 0.5s forwards; }
        @keyframes card-in { to { opacity: 1; transform: translateY(0) scale(1); } }
        .skeleton-card { background-color: var(--secondary-bg); border-radius: 10px; padding: 10px; margin-bottom: 12px; min-height: 180px; position: relative; overflow: hidden; }
        .skeleton-card::after { content: ''; position: absolute; top: 0; left: -150%; width: 150%; height: 100%; background: var(--skeleton-gradient); animation: skeleton-shine 1.5s infinite; }
        @keyframes skeleton-shine { 0% { left: -150%; } 100% { left: 150%; } }
        .horizontal-scroll-container .skeleton-card { min-width: 220px; flex-shrink: 0; margin-bottom: 0; }
        .card-top-row { display: flex; flex-wrap:wrap; gap: 6px; font-size: 0.7rem; color: var(--text-secondary); font-weight: 500; }
        .card-top-row span { background-color: rgba(0,0,0,0.2); padding: 3px 8px; border-radius: 5px; font-weight: 500;}
        .card-title { font-size: 0.9rem; font-weight: 500; margin: 4px 0; word-break: break-word; }
        .countdown-timer { font-size: 0.75rem !important; margin: 4px 0 !important; text-align:center; color:var(--text-secondary);}
        .card-details-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(70px, 1fr)); gap: 6px; padding: 6px 0; border-top: 1px solid var(--tab-border-color); border-bottom: 1px solid var(--tab-border-color); margin: 12px 0; }
        .detail-item { text-align: center; }
        .detail-item .label { font-size: 0.65rem; color: var(--text-tertiary); margin-bottom: 2px; }
        .detail-item .value { font-size: 0.85rem; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 4px; }
        .detail-item .material-icons { font-size: 14px; color: var(--coin-gold); }
        .card-footer { display: flex; justify-content: space-between; align-items: center; gap: 10px; margin-top: 8px; }
        .progress-bar-container { flex-grow: 1; }
        .progress-bar-info { font-size: 0.75rem; color: var(--text-tertiary); margin-bottom: 4px; cursor: pointer; }
        .progress-bar { height: 6px; background-color: var(--primary-bg); border-radius: 10px; overflow: hidden; }
        .progress-bar-fill { background: linear-gradient(90deg, var(--coin-gold), #ff9800); height: 100%; border-radius: 10px; }
        .join-btn {
            background-color: var(--button-main-bg);
            color: var(--button-main-text);
            border: none;
            padding: 7px 15px;
            border-radius: 20px;
            font-weight: 600;
            cursor: pointer;
            font-size: 0.85rem;
            transition: transform 0.1s ease, box-shadow 0.2s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .join-btn:disabled, .action-btn:disabled, .report-win-btn:disabled, .report-loss-btn:disabled {
            background: #8e85a9 !important;
            cursor: not-allowed !important;
            color: #eee !important;
            box-shadow: none !important;
        }
        .join-btn:hover:not(:disabled) { box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        .room-credentials { background: var(--primary-bg); border: 1px solid var(--accent-green); border-radius: 8px; padding: 10px; margin: 8px 0; text-align: center; font-size:0.9rem;}
        .room-credentials div { margin-bottom: 5px; }
        .room-credentials span { font-weight: 600; color: var(--accent-green); letter-spacing: 1px; }
        .player-result-info { background: var(--primary-bg); border-radius: 8px; padding: 8px; margin-top: 8px; text-align: center; font-size: 0.85rem;}
        .player-result-info span { font-weight: 600; color: var(--coin-gold); margin: 0 8px; }
        .custom-match-card .instructions { font-size: 0.8rem; color: var(--accent-green); margin-top:8px; padding:6px; background-color: rgba(31,191,115,0.1); border-left:3px solid var(--accent-green); border-radius: 4px;}
        .card-settings-block { font-size: 0.7rem; color: var(--text-tertiary); padding: 8px 5px; border-top: 1px solid rgba(255, 255, 255, 0.1); margin-top: 8px; display: flex; flex-direction: column; gap: 4px; }
        .setting-row { display: flex; gap: 10px; align-items: center; }
        .setting-col { display: flex; gap: 4px; align-items: center; flex-basis: 50%; min-width: 0; }
        .setting-col.full { flex-basis: 100%; }
        .setting-col .label { white-space: nowrap; }
        .setting-col .value { font-weight: 600; color: var(--text-primary); text-shadow: 1px 1px 2px rgba(0,0,0,0.5); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .setting-col .value.yes { color: var(--accent-green); }
        .setting-col .value.no { color: var(--accent-red); }
        .setting-col .value.players-value { font-weight: normal; color: var(--text-secondary); text-align: left; }
        .custom-match-card .card-footer { flex-direction: row; justify-content: flex-end; align-items: center; margin-top: 10px; }
        .custom-match-card .card-footer .footer-info { display: none; }
        .custom-match-card .card-footer .join-btn { flex-shrink: 0; }
        .challenge-room-update-section { background-color: rgba(0,0,0,0.2); border-radius: 8px; padding: 10px; margin-top: 10px; border: 1px dashed var(--text-tertiary); }
        .challenge-room-update-section .form-group { margin-bottom: 8px; }
        .challenge-room-update-section label { font-size: 0.7rem; color: var(--text-tertiary); }
        .challenge-room-update-section input { width: 100%; background: var(--primary-bg); border: 1px solid var(--tab-border-color); color: var(--text-primary); padding: 8px; border-radius: 6px; font-size: 0.85rem;}
        .challenge-room-update-section button { width: 100%; margin-top: 8px;}
        .bottom-nav{display:flex;justify-content:space-around;background-color:var(--secondary-bg);padding:10px 0;border-top:1px solid var(--tab-border-color);}
        .nav-item{display:flex;flex-direction:column;align-items:center;color:var(--text-tertiary);text-decoration:none;gap:4px;font-size:0.75rem;cursor:pointer;flex:1;text-align:center;}
        .nav-item .material-icons { font-size: 22px; }
        .nav-item.active{color:var(--text-primary);}
        .chat-messages { flex-grow: 1; overflow-y: auto; padding: 10px; display: flex; flex-direction: column; gap: 5px; }
        .message-row { display: flex; width: 100%; }
        .message-row.sent { justify-content: flex-end; }
        .message-row.received { justify-content: flex-start; }
        .chat-message { display: flex; flex-direction: column; padding: 5px 10px; border-radius: 15px; max-width: 75%; word-wrap: break-word; font-size: 0.8rem;}
        .chat-message.sent { background: var(--chat-sent-bg); border-bottom-right-radius: 3px; }
        .chat-message.received { background: var(--secondary-bg); border-bottom-left-radius: 3px; }
        .chat-message .sender { font-weight: 600; color: var(--accent-red); font-size: 0.75rem; margin-bottom: 1px; cursor:pointer;}
        .chat-message .text { margin: 0; padding: 0; text-align: left; }
        #chat-form { display: flex; padding: 8px; background: var(--primary-bg); border-top: 1px solid var(--secondary-bg); }
        #chat-input { flex-grow: 1; background: var(--secondary-bg); border: 1px solid var(--tab-border-color); border-radius: 18px; padding: 8px 12px; color: var(--text-primary); outline: none; font-size:0.9rem;}
        #chat-form button { background: none; border: none; color: var(--accent-green); padding: 0 12px; cursor: pointer; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; display: flex; justify-content: center; align-items: center; }
        .modal-content { background: var(--secondary-bg); color: var(--text-primary); border-radius: 15px; width: 90%; max-width: 400px; position: relative; display:flex; flex-direction:column; max-height: 85vh; }
        .modal-header { padding: 15px 15px 10px; }
        .modal-body { padding: 10px 15px; overflow-y: auto; }
        .modal-close-btn { position: absolute; top: 8px; right: 10px; font-size: 1.8rem; cursor: pointer; color: var(--text-tertiary); }
        .modal-header h2 { text-align: center; font-size:1.2rem; margin-bottom: 5px;}
        .modal-tab-content { padding-top: 15px; }
        .modal-form .form-group { margin-bottom: 12px; text-align:left; }
        .modal-form .form-group label { display: block; margin-bottom: 5px; color: var(--text-secondary); font-size:0.85rem; }
        .modal-form .form-group input { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--tab-border-color); background: var(--primary-bg); color: var(--text-primary); font-size:0.9rem;}
        .modal-form button { width: 100%; padding: 12px; background: var(--button-main-bg); color: var(--button-main-text); border: none; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer; margin-top: 10px; }
        #wallet-modal .modal-content { max-width: 380px; padding-bottom: 15px; }
        #wallet-modal .modal-header { padding: 15px 15px 0; }
        #wallet-modal .modal-header h2 { font-size: 1.3rem; margin-bottom: 8px; }
        #wallet-modal .wallet-breakdown { font-size: 0.85rem; padding: 8px; margin-bottom: 10px; }
        #wallet-modal .tabs a { padding-bottom: 6px; }
        #wallet-modal .modal-body { padding: 10px 15px; }
        #wallet-modal .modal-tab-content { padding-top: 10px; }
        #wallet-modal .modal-form .form-group { margin-bottom: 10px; }
        #wallet-modal .modal-form .form-group label { font-size: 0.8rem; margin-bottom: 3px; }
        #wallet-modal .modal-form .form-group input { padding: 8px 10px; font-size: 0.9rem; }
        #wallet-modal .modal-form button { padding: 10px; font-size: 0.9rem; margin-top: 8px; }
        #add-money .qr-code-area img { width: 110px; height: 110px; }
        #add-money .qr-code-area p { font-size: 0.8rem; margin-top: 3px; }
        #add-money .whatsapp-contact { margin-top: 10px; padding-top: 8px; }
        #add-money .whatsapp-contact p { font-size: 0.7rem !important; margin-bottom: 6px !important; }
        #add-money .whatsapp-btn { padding: 7px 12px; font-size: 0.8rem; }
        #add-money .whatsapp-btn svg { width: 16px; height: 16px; }
        #wallet-modal .transaction-history-list .transaction-item { padding: 8px; margin-bottom: 8px; }
        #wallet-modal .transaction-history-list .transaction-item .icon { margin-right: 10px; font-size: 1.8rem; }
        #wallet-modal .transaction-history-list .transaction-item .details .amount { font-size: 0.85rem; }
        #wallet-modal .transaction-history-list .transaction-item .details .time { font-size: 0.7rem; }
        #wallet-modal .transaction-history-list .transaction-item .status { font-size: 0.7rem; padding: 2px 6px; }
        .transaction-item { display: flex; align-items: center; background: var(--secondary-bg); padding: 10px; border-radius: 8px; margin-bottom: 10px; }
        .transaction-item .icon { margin-right: 15px; font-size:1.8rem; }
        .transaction-item .icon.add { color: var(--accent-green); }
        .transaction-item .icon.withdraw { color: var(--accent-red); }
        .transaction-item .details { flex-grow: 1; }
        .transaction-item .details .amount { font-weight: 600; font-size:0.9rem;}
        .transaction-item .details .time { font-size: 0.8rem; color: var(--text-tertiary); }
        .transaction-item .status { padding: 3px 8px; border-radius: 10px; font-size: 0.75rem; font-weight: 600; text-transform: capitalize; }
        .status.pending { background-color: var(--coin-gold); color: black; }
        .status.completed { background-color: var(--accent-green); color: var(--primary-bg); }
        .status.rejected { background-color: var(--accent-red); color: var(--text-primary); }
        .status.unknown { background-color: var(--text-tertiary); color: var(--text-primary); }
        .whatsapp-contact { margin-top: 20px; text-align: center; }
        .whatsapp-btn { background-color: #25D366; color: white; padding: 10px 20px; border-radius: 50px; text-decoration: none; display: inline-flex; align-items: center; gap: 10px; font-weight: 600; }
        .whatsapp-btn svg { width: 24px; height: 24px; fill: white; }
        #toast-container { position: fixed; bottom: 50px; left: 50%; transform: translateX(-50%); z-index: 3000; display: flex; flex-direction: column-reverse; gap: 10px; align-items: center; pointer-events:none; width: calc(100% - 40px); max-width: 560px; }
        .toast { padding: 10px 25px; border-radius: 8px; color: white; font-weight: 500; box-shadow: 0 4px 15px rgba(0,0,0,0.2); opacity: 0; transform: translateY(20px); animation: toast-in-bottom 0.5s forwards; font-size: 0.9rem; width: 100%; text-align: center; }
        .toast.success { background: var(--accent-green); }
        .toast.error { background: var(--accent-red); }
        .toast.warning { background: var(--coin-gold); color: var(--primary-bg); }
        .toast.hide { animation: toast-out-bottom 0.5s forwards; }
        @keyframes toast-in-bottom { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes toast-out-bottom { from { opacity: 1; transform: translateY(0); } to { opacity: 0; transform: translateY(20px); } }
        .notification-item { background: var(--primary-bg); padding: 10px 15px; margin-bottom:10px; border-radius: 8px; border-left: 3px solid var(--accent-green); }
        .notification-item.error { border-left-color: var(--accent-red); }
        .notification-item p { margin: 0 0 5px 0; font-size:0.9rem; }
        .notification-item .timestamp { font-size: 0.8rem; color: var(--text-tertiary); text-align: right; }
        #custom-matches-page .form-group { margin-bottom: 15px; }
        #custom-matches-page .form-group label { display: block; margin-bottom: 3px; color: var(--text-secondary); font-size:0.85rem; }
        #custom-matches-page .form-group select, #custom-matches-page .form-group input { width: 100%; padding: 9px; border-radius: 8px; border: 1px solid var(--tab-border-color); background: var(--primary-bg); color: var(--text-primary); font-size:0.9rem; }
        #custom-matches-page .btn {width:100%;}
        #create-custom-match-form { display: grid; grid-template-columns: 1fr 1fr; gap: 10px 15px; }
        #create-custom-match-form h3, #create-custom-match-form h4, #create-custom-match-form p, #create-custom-match-form button { grid-column: 1 / -1; }
        .filter-select { background: var(--secondary-bg); color: var(--text-primary); border: 1px solid var(--tab-border-color); padding: 8px; border-radius: 8px; font-size: 0.9rem; flex-grow: 1; }
        #custom-challenges-filters { display:flex; gap:10px; margin-bottom:10px; flex-wrap:wrap; }
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--primary-bg); display: flex; justify-content: center; align-items: center; z-index: 9999; flex-direction: column; gap: 20px; color: var(--text-primary); }
        .loader { border: 5px solid var(--secondary-bg); border-top: 5px solid var(--accent-green); border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        #dashboard-page {
            display: flex;
            flex-direction: column;
            padding: 15px;
            gap: 20px;
            overflow-y: auto;
        }
        
        /* === UPDATED: LAYOUT FIX FOR BANNERS === */
        .dashboard-banner {
            border-radius: 15px;
            padding: 15px 20px; /* Increased padding */
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
            overflow: hidden;
            position: relative;
            min-height: 100px;
            animation: banner-fade-in 0.6s ease-out forwards;
            opacity: 0;
            transform: translateY(10px);
        }
        @keyframes banner-fade-in { to { opacity: 1; transform: translateY(0); } }
        .dashboard-banner:nth-of-type(2) { animation-delay: 0.1s; }
        .dashboard-banner:nth-of-type(3) { animation-delay: 0.2s; }
        .whatsapp-banner { background: linear-gradient(135deg, #25D366, #128C7E); }
        .challenge-banner { background: linear-gradient(135deg, #6a11cb, #2575fc); }

        .dashboard-banner .banner-content {
            z-index: 1;
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: center;
            height: 100%;
        }
        .dashboard-banner h3 { font-size: 1rem; margin-bottom: 4px; }
        .dashboard-banner p {
            font-size: 0.8rem;
            opacity: 0.9;
            max-width: 220px;
            line-height: 1.4;
            flex-grow: 1; /* Allow p to take space */
            margin-bottom: 0;
        }
        .referral-banner p { max-width: none; } /* Allow referral p to be wider */
        .dashboard-banner .banner-btn {
            background-color: rgba(255, 255, 255, 0.9);
            color: #333;
            padding: 6px 14px;
            border-radius: 20px;
            text-decoration: none;
            font-weight: 600;
            font-size: 0.8rem;
            transition: transform 0.2s ease;
            display: inline-block;
            white-space: nowrap;
            margin-top: 10px; /* Add margin to separate from text */
            align-self: flex-start; /* Prevent stretching */
        }
        
        .dashboard-banner .banner-btn:hover { transform: scale(1.05); }
        .dashboard-banner .banner-icon { height: 75px; width: 75px; position: absolute; right: 10px; bottom: -5px; opacity: 0.2; transform: rotate(15deg); }
        .matches-section .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .matches-section .section-header h4 { font-size: 1.1rem; color: var(--text-secondary); }
        .matches-section .section-header .view-all-link { font-size: 0.8rem; color: var(--accent-green); text-decoration: none; font-weight: 500; }
        .horizontal-scroll-container { display: flex; gap: 12px; overflow-x: auto; padding-bottom: 15px; -ms-overflow-style: none; scrollbar-width: none; }
        .horizontal-scroll-container::-webkit-scrollbar { display: none; }
        .horizontal-scroll-container .tournament-card, .horizontal-scroll-container .custom-match-card { transition: transform 0.2s ease-out, box-shadow 0.2s ease-out; }
        .horizontal-scroll-container .tournament-card:hover, .horizontal-scroll-container .custom-match-card:hover { transform: translateY(-5px); box-shadow: 0 8px 15px rgba(0,0,0,0.2); }
        .tournament-card, .custom-match-card { min-width: 220px; flex-shrink: 0; padding: 15px; display: flex; flex-direction: column; justify-content: space-between; position: relative; background-size: cover; background-position: center; overflow: hidden; background-color: var(--secondary-bg); }
        
        /* === UPDATED: CSS rules for background images and visibility === */
        .tournament-card[data-gametype="FREEFIRE"],
        .custom-match-card[data-gametype="FREEFIRE"] {
            background-image: linear-gradient(rgba(0,0,0,0.6), rgba(0,0,0,0.8)), url('https://i.ibb.co/XrRPGTDL/FREE-FIRE-THUMBNAIL-FREE-TO-USE.jpg');
        }
        .tournament-card[data-gametype="BGMI"],
        .custom-match-card[data-gametype="BGMI"] {
            background-image: linear-gradient(rgba(0,0,0,0.6), rgba(0,0,0,0.8)), url('https://i.ibb.co/23nk9Sxj/Awesome-PUBG-4-K-Gaming-Wallpapers-Wallpaper-Access.jpg');
        }
        .custom-match-card {
             background-image: linear-gradient(rgba(0,0,0,0.6), rgba(0,0,0,0.8)), url('https://i.ibb.co/NdcGkZRX/DJEXO-FF-RUOK-FF-VS-4-YOUTUBERS-Dangerous-fight-ever.jpg');
        }

        .tournament-card .label, .custom-match-card .label, .tournament-card .card-title, .custom-match-card .card-title, .tournament-card .detail-item .value, .custom-match-card .detail-item .value, .tournament-card .progress-bar-info, .custom-match-card .progress-bar-info {
            color: var(--text-primary);
            text-shadow: 1px 1px 4px rgba(0, 0, 0, 0.85); /* Stronger shadow for visibility */
        }
        .tournament-card .card-details-grid, .custom-match-card .card-details-grid { gap: 4px; padding: 4px 0; margin: 6px 0; border-top: 1px solid rgba(255, 255, 255, 0.1); border-bottom: 1px solid rgba(255, 255, 255, 0.1); }
        .tournament-card .card-details-grid { margin: 12px 0; }
        .tournament-card .detail-item .label, .custom-match-card .detail-item .label { font-size: 0.6rem; }
        .tournament-card .detail-item .value, .custom-match-card .detail-item .value { font-size: 0.8rem; }
        .tournament-card .detail-item .material-icons, .custom-match-card .detail-item .material-icons { font-size: 12px; }
        .tournament-card .card-top-row span, .custom-match-card .card-top-row span { background-color: rgba(0, 0, 0, 0.4); }
        .tournament-card .card-title, .custom-match-card .card-title { font-size: 0.9rem; font-weight: 700; margin: 4px 0 8px 0; line-height: 1.3; }
        .tournament-card .card-footer, .custom-match-card .card-footer { margin-top: auto; }
        .tournament-card .card-footer .join-btn, .custom-match-card .card-footer .join-btn { padding: 4px 10px; font-size: 0.7rem; }
        .tournament-card .countdown-timer, .custom-match-card .countdown-timer { font-size: 0.7rem !important; margin: 2px 0 !important; }
        .tournament-card .progress-bar-info, .custom-match-card .progress-bar-info { font-size: 0.7rem; }


        #theme-settings-modal .modal-body { display: flex; flex-direction: column; gap: 10px; padding: 20px; }
        #theme-settings-modal .theme-btn { padding: 10px 15px; border: 1px solid var(--text-tertiary); background-color: var(--secondary-bg); color: var(--text-primary); border-radius: 8px; cursor: pointer; text-align: center; font-weight: 500; }
        #theme-settings-modal .theme-btn.active { background-color: var(--accent-green); border-color: var(--accent-green); color: white; }
        #logout-confirm-modal .modal-content { max-width: 320px; padding: 20px; }
        #logout-confirm-modal h2 { font-size: 1.2rem; margin-bottom: 15px; text-align: center; }
        #logout-confirm-modal p { font-size: 0.95rem; color: var(--text-secondary); margin-bottom: 25px; text-align: center; line-height: 1.5; }
        #logout-confirm-modal .modal-actions { display: flex; gap: 10px; justify-content: center; }
        #logout-confirm-modal .modal-actions button { flex-grow: 1; padding: 10px; border-radius: 8px; font-weight: 600; font-size: 0.9rem; cursor: pointer; border: none; }
        #confirm-logout-btn { background-color: var(--accent-red); color: white; }
        #cancel-logout-btn { background-color: var(--text-tertiary); color: var(--text-primary); }
        .report-win-btn {
            background-color: var(--accent-green);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            flex-grow: 1;
            font-size: 0.85rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: transform 0.1s ease, box-shadow 0.2s ease;
            text-align: center;
            text-decoration: none;
        }
        .report-win-btn:active { transform: scale(0.97); }
        .report-loss-btn {
            background-color: var(--accent-red);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            flex-grow: 1;
            font-size: 0.85rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: transform 0.1s ease, box-shadow 0.2s ease;
            text-align: center;
            text-decoration: none;
        }
        .report-loss-btn:active { transform: scale(0.97); }
        #edit-bio-modal .modal-content {
            max-width: 350px;
            padding: 20px;
        }
        #edit-bio-modal h2 {
            margin-bottom: 15px;
            font-size: 1.1rem;
        }
        #edit-bio-modal .form-group {
            margin-bottom: 15px;
        }
        #edit-bio-modal textarea {
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid var(--tab-border-color);
            background: var(--primary-bg);
            color: var(--text-primary);
            font-size: 0.9rem;
            min-height: 80px;
            resize: vertical;
        }
        #edit-bio-modal button {
            width: 100%;
            padding: 10px;
            background: var(--button-main-bg);
            color: var(--button-main-text);
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            font-size: 0.9rem;
        }
        
        /* NEW: Spin Wheel CSS */
        .wheel-container { position: relative; width: 250px; height: 250px; }
        .wheel-pointer {
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 15px solid transparent;
            border-right: 15px solid transparent;
            border-top: 25px solid #ff4757; /* Bright pointer color */
            z-index: 10;
        }
        .wheel {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            position: relative;
            overflow: hidden;
            border: 5px solid var(--coin-gold);
            transition: transform 5s cubic-bezier(0.25, 0.1, 0.25, 1); /* Smooth spin animation */
        }
        .wheel-segment {
            position: absolute;
            width: 50%;
            height: 50%;
            transform-origin: 100% 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text-primary);
            text-align: center;
            padding-left: 20px;
            box-sizing: border-box;
        }
        .wheel-segment span {
            display: block;
            transform: rotate(45deg);
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }

    </style>
</head>
<body>
    <!-- The HTML Body remains unchanged -->
    <!-- ... (All your existing body content) ... -->
    <div id="loading-overlay">
        <div class="loader"></div>
        <p>Loading App...</p>
    </div>

    <!-- Auth Wrapper -->
    <div id="auth-wrapper">
        <div class="auth-form-container">
            <div class="auth-form-card">
                <div id="register-container">
                    <h1>Create Account</h1>
                    <form id="register-form">
                        <div class="auth-form-group"><label for="register-email" class="hidden">Email</label><input type="email" id="register-email" placeholder="Email" required></div>
                        <div class="auth-form-group"><label for="register-password" class="hidden">Password</label><input type="password" id="register-password" placeholder="Password" required></div>
                        <h4 style="font-size: 1rem; color: #555; margin-top:15px; margin-bottom:10px;">Game Info (Optional)</h4>
                        <div class="auth-form-group"><label for="register-ff-ign" class="hidden">Free Fire IGN</label><input type="text" id="register-ff-ign" placeholder="Your Free Fire Name (IGN)" pattern="[a-zA-Z0-9\s_.-]*" title="Only alphanumeric, spaces, underscore, hyphen, and dot are allowed."></div>
                        <div class="auth-form-group"><label for="referral-code-input" class="hidden">Referral Code</label><input type="text" id="referral-code-input" placeholder="Referral Code (Optional)"></div>
                        <button type="submit" class="auth-submit-btn">REGISTER</button>
                    </form>
                    <p class="auth-toggle-link-p">Already a user? <a id="show-login-link" class="auth-toggle-link">Log In Now!</a></p>
                </div>
                <div id="login-container" class="hidden">
                    <h1>Welcome Back!</h1>
                    <form id="login-form">
                        <div class="auth-form-group"><label for="login-email" class="hidden">Email</label><input type="email" id="login-email" placeholder="Email" required></div>
                        <div class="auth-form-group"><label for="login-password" class="hidden">Password</label><input type="password" id="login-password" placeholder="Password" required></div>
                        <button type="submit" class="auth-submit-btn">LOGIN</button>
                    </form>
                    <p class="auth-toggle-link-p" style="text-align:right; margin-top:10px; margin-bottom: -15px;"><a id="forgot-password-link" class="auth-toggle-link" style="font-size:0.85rem; font-weight:normal;">Forgot Password?</a></p>
                    <p class="auth-toggle-link-p">New user? <a id="show-register-link" class="auth-toggle-link">Register Now!</a></p>
                </div>
                <div id="auth-message" class="auth-message"></div>
            </div>
        </div>
    </div>

    <!-- App Wrapper -->
    <div id="app-wrapper" class="hidden">
        <div class="app-container">
            <header class="app-header">
                <div class="header-left">
                    <h1 id="header-title" class="header-title">HOME</h1>
                </div>
                <div class="header-right">
                    <!-- NEW: Streak Counter -->
                    <div id="streak-container" class="hidden">
                        <span class="material-icons">whatshot</span>
                        <span id="streak-count">0</span>
                    </div>
                    <div class="wallet" role="button" tabindex="0" aria-label="Open wallet"><span class="material-icons">account_balance_wallet</span><span id="header-wallet-balance">--</span></div>
                    <span id="notification-btn" class="material-icons" role="button" tabindex="0" aria-label="View notifications">notifications<span id="notification-dot" class="notification-dot hidden"></span></span>
                </div>
            </header>
            <main>
                <div id="dashboard-page" class="page">
                    <div class="dashboard-banner whatsapp-banner">
                        <div class="banner-content">
                            <h3>Get Instant Match Alerts!</h3>
                            <p>Join our WhatsApp group for Room ID/Pass & match notifications.</p>
                            <a href="#" id="dashboard-whatsapp-link" target="_blank" class="banner-btn">Join Now</a>
                        </div>
                        <img src="https://i.ibb.co/Wvj9NPBP/whatsapp-1.png" alt="WhatsApp Icon" class="banner-icon">
                    </div>

                    <div id="referral-banner" class="dashboard-banner referral-banner hidden">
                        <div class="banner-content">
                            <h3>Got a Referral Code?</h3>
                            <p>Enter a friend's code to get a special welcome bonus in your wallet!</p>
                            <a href="#" id="claim-referral-btn" class="banner-btn">Claim Now</a>
                        </div>
                        <img src="https://i.ibb.co/L8y2z2p/gift-icon-png-21.png" alt="Gift Icon" class="banner-icon" style="opacity: 0.15; height: 70px; width: 70px;">
                    </div>
                    
                    <!-- NEW: Spin the Wheel Banner -->
                    <div id="spin-wheel-banner" class="dashboard-banner hidden" style="background: linear-gradient(135deg, #ff9a9e 0%, #fad0c4 99%, #fad0c4 100%); cursor: pointer;">
                        <div class="banner-content">
                            <h3 style="color: #d6336c;">Kismat ka Chakra</h3>
                            <p style="color: #d6336c;">Apna daily free spin istemal karein aur jeetein awesome rewards!</p>
                            <span class="banner-btn" style="background-color: #d6336c; color: white;">Spin Now!</span>
                        </div>
                        <img src="https://i.ibb.co/k2g7y7j/wheel.png" alt="Spin Wheel" class="banner-icon" style="opacity: 0.5;">
                    </div>

                    <div class="matches-section">
                        <div class="section-header">
                            <h4>Upcoming Tournaments</h4>
                            <a href="#" class="view-all-link" data-targetpage="matches-page" data-status="upcoming">View All</a>
                        </div>
                        <div class="horizontal-scroll-container" id="dashboard-upcoming-matches">
                            <!-- Skeleton loaders will be inserted here by JS -->
                        </div>
                    </div>

                    <div class="matches-section">
                        <div class="section-header">
                            <h4>Ongoing Tournaments</h4>
                            <a href="#" class="view-all-link" data-targetpage="matches-page" data-status="ongoing">View All</a>
                        </div>
                        <div class="horizontal-scroll-container" id="dashboard-ongoing-matches">
                            <!-- Skeleton loaders will be inserted here by JS -->
                        </div>
                    </div>

                    <div class="dashboard-banner challenge-banner">
                        <div class="banner-content">
                            <h3>Create Your Own Challenge!</h3>
                            <p>Play 1v1 or 2v2 matches with your friends or other players.</p>
                            <a href="#" id="dashboard-challenge-link" class="banner-btn">Create Now</a>
                        </div>
                        <img src="https://i.ibb.co/fdyG0V9R/images.jpg" alt="Gamepad Icon" class="banner-icon">
                    </div>
                </div>

                <div id="profile-page" class="page">
                    <div class="profile-header-card">
                        <button id="profile-settings-btn-header" aria-label="Theme Settings"><span class="material-icons">settings</span></button>
                        <button id="profile-logout-btn-header" aria-label="Logout"><span class="material-icons">logout</span></button>
                        <div class="profile-pic-container">
                            <div id="my-profile-likes-display-container">
                                <span id="my-profile-likes-display" class="profile-likes-golden">
                                    <span class="material-icons">thumb_up_alt</span>
                                    <span id="my-profile-likes-count-text">0 Likes</span>
                                </span>
                            </div>
                            <label for="pfp-upload"><img id="profile-pic" class="profile-pic" src="https://i.ibb.co/kg3pNBYp/5ed1a03049fcf64db0712bdca67c9390.jpg" alt="Profile picture"></label>
                            <input type="file" id="pfp-upload" accept="image/*">
                        </div>
                        <h2 id="profile-name" class="profile-name">User Full Name</h2>
                        <p id="profile-bio" class="profile-bio" style="margin-top: 8px;">
                            No bio set. <span id="edit-bio-btn" class="material-icons" role="button" tabindex="0" aria-label="Edit bio">edit</span>
                        </p>
                        <div id="profile-actions-container" style="margin-top: 15px; display:flex; align-items:center; justify-content:center; gap:20px;" class="hidden">
                            <button id="like-profile-btn" class="action-btn like-btn-golden">
                                <span class="material-icons">thumb_up_alt</span>
                                <span>Like</span>
                            </button>
                            <span id="profile-likes-count-on-others-page" class="profile-likes-golden">
                                <span class="material-icons">thumb_up_alt</span>
                                <span>0 Likes</span>
                            </span>
                        </div>
                        <div class="referral-box">
                            <span>My Referral : <strong id="referral-code"></strong></span>
                            <button id="copy-ref-btn" class="material-icons" role="button" tabindex="0" aria-label="Copy referral code">content_copy</button>
                        </div>
                    </div>

                    <div class="game-ids-section">
                        <h4 style="font-size:0.9rem; color:var(--text-secondary); text-align:center; margin-bottom:10px;">FREE FIRE INFO</h4>
                        <div id="freefire-game-content" class="game-id-content">
                             <div class="form-group">
                                <label for="freefire-ign-input">Free Fire In-Game Name (IGN)</label>
                                <input type="text" id="freefire-ign-input" placeholder="Your Free Fire IGN" pattern="[a-zA-Z0-9\s_.-]*" title="Only alphanumeric, spaces, underscore, hyphen, and dot are allowed.">
                            </div>
                        </div>
                        <button id="profile-save-btn" class="profile-save-btn">Save Game Info</button>
                    </div>

                    <div class="profile-stats-grid">
                        <div class="stat-box"><div id="matches-played" class="value">0</div><div class="label">Matches Played</div></div>
                        <div class="stat-box"><div id="total-winnings" class="value">0</div><div class="label">Total Winnings</div></div>
                    </div>

                    <!-- NEW: Performance Graphs Section -->
                    <div class="profile-performance-section" style="display: none;">
                        <h4 style="text-align: center; color: var(--text-secondary); margin-bottom: 15px;">Performance Stats</h4>
                        <div style="width: 100%; max-width: 400px; margin: 0 auto;">
                            <canvas id="winLossChart"></canvas>
                        </div>
                        <div style="width: 100%; max-width: 400px; margin: 20px auto 0;">
                            <canvas id="killDeathChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="profile-page-actions">
                        <button id="game-rules-btn" class="profile-save-btn">Game Rules & Fair Play</button>
                    </div>
                </div>

                <div id="matches-page" class="page" style="padding:0;">
                    <nav class="button-style-tabs" id="game-type-tabs">
                        <a data-gametype="FREEFIRE" class="active">FREE FIRE</a>
                        <a data-gametype="BGMI">BGMI</a>
                    </nav>
                    <nav class="button-style-tabs" id="match-status-tabs">
                        <a data-status="upcoming" class="active">UPCOMING</a>
                        <a data-status="ongoing">ONGOING</a>
                        <a data-status="results">RESULTS</a>
                    </nav>
                    <div class="tournament-list" style="padding:15px; flex-grow:1; overflow-y:auto; display: flex; flex-direction: column; gap: 12px;">
                        <!-- Skeleton loaders will be inserted here by JS -->
                    </div>
                </div>

                <div id="history-page" class="page" style="padding:15px;"><div class="history-list" style="display: flex; flex-direction: column; gap: 12px;"></div></div>

                <div id="custom-matches-page" class="page" style="padding:0;">
                    <nav class="button-style-tabs" id="custom-match-main-tabs">
                        <a data-subpage="create-custom-match">Create Challenge</a>
                        <a data-subpage="join-custom-match" class="active">Join Challenge</a>
                        <a data-subpage="my-custom-matches">My Challenges</a>
                    </nav>
                    <div id="create-custom-match" class="custom-match-subpage" style="padding:15px; display:none; flex-direction:column; gap:15px; overflow-y:auto; flex-grow:1;">
                        <form id="create-custom-match-form">
                            <h3>Create New Challenge</h3>
                            <div class="form-group">
                                <label for="cm-game-type">Game</label>
                                <select id="cm-game-type">
                                    <option value="FREEFIRE">FREE FIRE</option>
                                    <option value="BGMI">BGMI</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="cm-match-type">Match Type</label>
                                <select id="cm-match-type"><option value="1v1">1 vs 1</option><option value="2v2">2 vs 2</option></select>
                            </div>
                            <div class="form-group">
                                <label for="cm-entry-fee">Entry Fee (Coins)</label>
                                <select id="cm-entry-fee"><option value="10">10</option><option value="20">20</option><option value="40">40</option><option value="50">50</option><option value="70">70</option></select>
                            </div>
                            <div class="form-group">
                                <label for="cm-privacy">Challenge Type</label>
                                <select id="cm-privacy"><option value="public">Public (Anyone can join)</option></select>
                            </div>

                            <p style="font-size:0.8rem; color:var(--text-secondary); grid-column: 1 / -1;">Prize Pool will be: <strong id="cm-prize-pool-display" style="color:var(--coin-gold);">18</strong> Coins</p>

                            <div id="freefire-settings-container" class="hidden" style="grid-column: 1 / -1; display: contents;">
                            </div>
                            <div id="bgmi-settings-container" class="hidden" style="grid-column: 1 / -1; display: contents;">
                            </div>
                            <h4 style="font-size:1rem; color:var(--text-secondary); margin-top:10px; margin-bottom:5px; border-bottom: 1px solid var(--tab-border-color); padding-bottom:5px;">Room Settings (Optional)</h4>
                             <p style="font-size:0.75rem; color:var(--text-tertiary); grid-column: 1 / -1; text-align:center;">No specific in-game settings for this challenge type. General rules apply.</p>


                            <p style="font-size: 0.75rem; color: var(--text-tertiary); margin: 10px 0; text-align: center;">By creating a challenge, you agree to our <a href="#" id="create-challenge-rules-link" style="color: var(--accent-green); text-decoration: underline;">Game Rules & Fair Play Policy</a>.</p>
                            <button type="submit" class="join-btn" style="width:100%;">Create Challenge</button>
                        </form>
                    </div>
                    <div id="join-custom-match" class="custom-match-subpage active" style="padding:15px; display:flex; flex-direction:column; gap:10px; overflow-y:auto; flex-grow:1;">
                        <h3>Available Challenges</h3>
                        <div id="custom-challenges-filters">
                            <select id="filter-cm-game-type" class="filter-select"><option value="">All Games</option><option value="BGMI">BGMI</option><option value="FREEFIRE">FREE FIRE</option></select>
                            <select id="filter-cm-match-type" class="filter-select"><option value="">All Types</option><option value="1v1">1v1</option><option value="2v2">2v2</option></select>
                            <select id="filter-cm-entry-fee" class="filter-select"><option value="">All Fees</option><option value="10">10</option><option value="20">20</option><option value="40">40</option><option value="50">50</option><option value="70">70</option></select>
                        </div>
                        <div class="tournament-list" id="available-custom-matches-list" style="padding:0; flex-grow:1; overflow-y:auto;">
                            <!-- Skeleton loaders will be inserted here by JS -->
                        </div>
                    </div>
                    <div id="my-custom-matches" class="custom-match-subpage" style="padding:15px; display:none; flex-direction:column; gap:10px; overflow-y:auto; flex-grow:1;">
                        <h3>Your Challenges</h3>
                        <div class="tournament-list" id="my-challenges-list" style="padding:0; flex-grow:1; overflow-y:auto;">
                           <!-- Skeleton loaders will be inserted here by JS -->
                        </div>
                    </div>
                </div>

                <div id="leaderboard-page" class="page" style="padding:0;">
                    <h2 style="text-align:center; padding: 15px 15px 0; color:var(--text-primary); background-color: var(--primary-bg); margin:0; position: sticky; top: 0; z-index: 11;">Top 100 Players</h2>
                    <div class="leaderboard-list"></div>
                </div>

                <div id="chat-page" class="page">
                    <div class="chat-messages"></div>
                    <form id="chat-form">
                        <input id="chat-input" type="text" placeholder="Type a message...">
                        <button type="submit" aria-label="Send message"><span class="material-icons">send</span></button>
                    </form>
                </div>
            </main>
            <nav class="bottom-nav">
                <a class="nav-item active" data-page="dashboard-page"><span class="material-icons">home</span><span>Home</span></a>
                <a class="nav-item" data-page="matches-page"><span class="material-icons">sports_esports</span><span>Matches</span></a>
                <a class="nav-item" data-page="custom-matches-page"><span class="material-icons">gamepad</span><span>Challenges</span></a>
                <a class="nav-item" data-page="leaderboard-page"><span class="material-icons">leaderboard</span><span>Leaderboard</span></a>
                <a class="nav-item" data-page="chat-page"><span class="material-icons">chat</span><span>Chat</span></a>
                <a class="nav-item" data-page="profile-page"><span class="material-icons">person</span><span>Profile</span></a>
            </nav>
        </div>
    </div>
    
    <!-- (All Modals HTML... Unchanged) -->
    <div id="spin-wheel-modal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width: 340px; background-color: #2c1f4a; border: 2px solid var(--coin-gold);">
            <div class="modal-header" style="padding-bottom: 0;">
                <span class="modal-close-btn">&times;</span>
                <h2 style="color: var(--coin-gold);">Spin & Win!</h2>
            </div>
            <div class="modal-body" style="padding: 20px; display: flex; flex-direction: column; align-items: center; gap: 20px;">
                <div class="wheel-container">
                    <div class="wheel-pointer"></div>
                    <div id="spin-wheel" class="wheel">
                        <!-- Segments will be added by JS -->
                    </div>
                </div>
                <button id="spin-btn" class="join-btn" style="padding: 10px 40px; font-size: 1.1rem;">SPIN</button>
                <p id="spin-result-text" style="font-weight: 600; color: var(--accent-green); min-height: 20px;"></p>
            </div>
        </div>
    </div>
    <div id="wallet-modal" class="modal-overlay hidden"><div class="modal-content"><div class="modal-header"><span class="modal-close-btn" role="button" tabindex="0" aria-label="Close modal"></span><h2>Wallet</h2><div class="wallet-breakdown">Total: <strong id="modal-wallet-balance">--</strong> (Deposit: <span id="deposit-balance">--</span> | Winnings: <span id="winnings-balance">--</span>)</div><div class="tabs button-style-tabs" id="wallet-tabs"><a class="active" data-tab="add-money">Add Coins</a><a data-tab="withdraw-money">Withdraw</a><a data-tab="history">History</a></div></div><div class="modal-body">
        <div id="add-money" class="modal-tab-content"><form id="add-money-form" class="modal-form"><div class="qr-code-area"><img id="upi-qr-code" src="" alt="Scan QR to pay via UPI"><p><strong>Scan and Pay using any UPI App</strong></p></div><div class="form-group"><label for="add-amount">Amount</label><input type="number" id="add-amount" placeholder="Enter amount to add" required></div><div class="form-group"><label for="utr-number">UTR/Transaction ID</label><input type="text" id="utr-number" placeholder="Enter payment UTR ID" required></div><button type="submit">Submit Request</button></form><div class="whatsapp-contact"><p>Payment karne ke baad, UTR number submit karein aur fir admin se contact karein request jaldi approve karwane ke liye.</p><a href="#" id="add-money-whatsapp-link" target="_blank" class="whatsapp-btn"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M.057 24l1.687-6.163c-1.041-1.804-1.588-3.849-1.587-5.946.003-6.556 5.338-11.891 11.893-11.891 3.181.001 6.167 1.24 8.413 3.488 2.245 2.248 3.481 5.236 3.48 8.414-.003 6.557-5.338 11.892-11.894 11.892-1.99-.001-3.951-.5-5.688-1.448l-6.305 1.654zm6.597-3.807c1.676.995 3.276 1.591 5.392 1.592 5.448 0 9.886-4.434 9.889-9.885.002-5.462-4.415-9.89-9.881-9.892-5.451 0-9.887 4.434-9.889 9.884-.001 2.225.651 3.891 1.746 5.634l-.999 3.648 3.742-.981zm11.387-5.464c-.074-.124-.272-.198-.57-.347-.297-.149-1.758-.868-2.031-.967-.272-.099-.47-.149-.669.149-.198.297-.768.967-.941 1.165-.173.198-.347.223-.644.074-.297-.149-1.255-.462-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.297-.347.446-.521.151-.172.2-.296.3-.495.099-.198.05-.371-.025-.521-.075-.148-.669-1.611-.916-2.206-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01s-.521.074-.792.372c-.272.296-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.626.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.695.248-1.289.173-1.413z"/></svg><span>Contact Admin</span></a></div></div>
        <div id="withdraw-money" class="modal-tab-content hidden"><form id="withdraw-money-form" class="modal-form"><div class="form-group"><label for="withdraw-number">PhonePe Number</label><input type="tel" id="withdraw-number" required></div><div class="form-group"><label for="withdraw-amount">Amount</label><input type="number" id="withdraw-amount" required></div><button type="submit">Request Withdrawal</button></form><div class="whatsapp-contact"><p style="font-size: 0.8rem; margin-bottom: 10px;">Request karne ke baad, admin se contact karein.</p><a href="#" id="whatsapp-link" target="_blank" class="whatsapp-btn"><svg viewBox="0 0 24 24" fill="currentColor" style="width: 24px; height: 24px;"><path d="M.057 24l1.687-6.163c-1.041-1.804-1.588-3.849-1.587-5.946.003-6.556 5.338-11.891 11.893-11.891 3.181.001 6.167 1.24 8.413 3.488 2.245 2.248 3.481 5.236 3.48 8.414-.003 6.557-5.338 11.892-11.894 11.892-1.99-.001-3.951-.5-5.688-1.448l-6.305 1.654zm6.597-3.807c1.676.995 3.276 1.591 5.392 1.592 5.448 0 9.886-4.434 9.889-9.885.002-5.462-4.415-9.89-9.881-9.892-5.451 0-9.887 4.434-9.889 9.884-.001 2.225.651 3.891 1.746 5.634l-.999 3.648 3.742-.981zm11.387-5.464c-.074-.124-.272-.198-.57-.347-.297-.149-1.758-.868-2.031-.967-.272-.099-.47-.149-.669.149-.198.297-.768.967-.941 1.165-.173.198-.347.223-.644.074-.297-.149-1.255-.462-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.297-.347.446-.521.151-.172.2-.296.3-.495.099-.198.05-.371-.025-.521-.075-.148-.669-1.611-.916-2.206-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01s-.521.074-.792.372c-.272.296-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.626.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.695.248-1.289.173-1.413z"/></svg><span>Contact Admin</span></a></div></div>
        <div id="history" class="modal-tab-content hidden"><div class="transaction-history-list"></div></div>
    </div></div></div>
    <div id="notification-panel" class="modal-overlay hidden"><div class="modal-content"><div class="modal-header"><span class="modal-close-btn" role="button" tabindex="0" aria-label="Close modal"></span><h2>Notifications</h2></div><div class="modal-body" id="notification-list"></div></div></div>
    <div id="joined-players-modal" class="modal-overlay hidden"><div class="modal-content"><div class="modal-header"><span class="modal-close-btn" role="button" tabindex="0" aria-label="Close modal"></span><h2>Joined Players</h2></div><div class="modal-body" id="joined-players-list"></div></div></div>
    <div id="rules-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header"><span class="modal-close-btn" role="button" tabindex="0" aria-label="Close modal"></span><h2>Game Rules & Fair Play Policy</h2></div>
            <div class="modal-body" style="text-align: left; font-size: 0.9rem; line-height: 1.6;">
                <h4 style="color: var(--accent-green); margin-bottom: 10px;">General Rules:</h4>
                <ul><li><strong>No Hacks or Cheats:</strong> Any use of third-party software, hacks, cheats, scripts, mods, or exploits will result in an immediate ban and forfeiture of all winnings and account balance.</li><li><strong>No Teaming (unless specified):</strong> In solo matches, teaming with other players is strictly prohibited. In squad matches, stick to your assigned team.</li><li><strong>Respectful Conduct:</strong> Abusive language, harassment, or unsportsmanlike behavior towards other players or admins will not be tolerated.</li><li><strong>Account Sharing:</strong> Your account is for your personal use only. Sharing accounts is forbidden.</li><li><strong>VPN/Proxy Usage:</strong> Using VPNs or proxies to manipulate location or gain an unfair advantage is not allowed.</li><li><strong>Bug Exploitation:</strong> Intentionally exploiting game bugs for an advantage is prohibited. Report bugs to the admin.</li></ul>
                <h4 style="color: var(--accent-red); margin-top: 20px; margin-bottom: 10px;">Anti-Cheat & Hacker Reporting Policy:</h4><p>We have a zero-tolerance policy against hackers and cheaters. To maintain a fair environment:</p>
                <ul><li><strong>Reporting a Suspected Hacker:</strong> If you encounter a player you suspect is using hacks or cheats, please try to gather video evidence.<ul><li style="margin-top:5px;">Record a clear video of the suspected player's gameplay showing the unfair advantage (e.g., aimbot, speed hack, wallhack).</li><li style="margin-top:5px;">Ensure the video includes the hacker's in-game name/ID if possible.</li><li style="margin-top:5px;">The video should be clear and unedited for investigation purposes.</li></ul></li><li style="margin-top:5px;"><strong>Submitting Proof:</strong> Send the video proof along with the Match ID and the suspected hacker's name to our Admin on <a href="#" id="rules-whatsapp-hacker-report" target="_blank" style="color: var(--accent-green); text-decoration: underline;">WhatsApp</a>.</li><li style="margin-top:5px;"><strong>Investigation & Refund:</strong><ul><li style="margin-top:5px;">Our team will investigate the report thoroughly.</li><li style="margin-top:5px;">If the player is confirmed to be a hacker, they will be permanently banned.</li><li style="margin-top:5px;"><strong>If you lost a match due to a confirmed hacker (and you were not involved in any rule-breaking yourself), your entry fee for that specific match will be refunded to your wallet.</strong> This applies to both official tournaments and custom challenges where applicable.</li></ul></li><li style="margin-top:5px;"><strong>False Reports:</strong> Submitting false or misleading reports repeatedly may lead to warnings or penalties.</li></ul>
                <h4 style="color: var(--accent-green); margin-top: 20px; margin-bottom: 10px;">Custom Challenge Specifics:</h4>
                <ul><li><strong>Match Settings:</strong> The match creator is responsible for setting up the custom room according to the agreed-upon challenge details (map, mode, etc.).</li><li><strong>Timeliness:</strong> Be on time for custom matches. Delays may result in disqualification or penalties.</li><li><strong>Proof of Victory:</strong> For custom challenges, the winning player/team MUST provide clear, unedited screenshot or video proof of victory to the admin via WhatsApp as instructed. Failure to provide proof may result in the prize not being awarded.</li><li><strong>Disputes:</strong> All disputes will be reviewed by the admin, whose decision will be final. Provide clear evidence for any claims.</li></ul>
                <h4 style="color: var(--accent-red); margin-top: 20px; margin-bottom: 10px;">Consequences of Violation:</h4><p>Violation of any rules may lead to warnings, temporary suspension, permanent account ban, and loss of any funds in your wallet, at the sole discretion of the admin team.</p>
                <p style="margin-top: 20px; text-align: center; font-weight: 600;">Play fair, play hard, and enjoy the game!</p>
            </div>
        </div>
    </div>
    <div id="user-inspect-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="inspect-header">
                <span class="modal-close-btn" role="button" tabindex="0" aria-label="Close modal">&times;</span>
                <div class="inspect-pic-container">
                    <img id="inspect-profile-pic" class="profile-pic" src="https://i.ibb.co/kg3pNBYp/5ed1a03049fcf64db0712bdca67c9390.jpg" alt="Profile picture">
                </div>
            </div>
            <div class="modal-body">
                <h3 id="inspect-profile-name">User Name</h3>
                <p id="inspect-profile-bio"></p>
                <div id="inspect-profile-stats">
                    <span id="inspect-profile-likes" class="profile-likes-golden">
                        <span class="material-icons">thumb_up_alt</span>
                        <span>0 Likes</span>
                    </span>
                </div>
                <div id="inspect-profile-actions">
                    <button id="inspect-like-btn" class="action-btn like-btn-golden">
                        <span class="material-icons">thumb_up_alt</span>
                        <span>Like</span>
                    </button>
                    <button id="inspect-view-full-profile-btn" class="action-btn">
                        View Full Profile
                    </button>
                </div>
            </div>
        </div>
    </div>
    <div id="update-room-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <span class="modal-close-btn" role="button" tabindex="0" aria-label="Close modal"></span>
                <h2>Update Room Details</h2>
            </div>
            <div class="modal-body">
                <form id="update-room-form" class="modal-form">
                    <input type="hidden" id="update-room-match-id">
                    <div class="form-group">
                        <label for="update-room-id-input">Room ID</label>
                        <input type="text" id="update-room-id-input" placeholder="Enter Room ID" required>
                    </div>
                    <div class="form-group">
                        <label for="update-room-pass-input">Room Password</label>
                        <input type="text" id="update-room-pass-input" placeholder="Enter Room Password (optional)">
                    </div>
                    <button type="submit">Update Details</button>
                </form>
            </div>
        </div>
    </div>
    <div id="theme-settings-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <span class="modal-close-btn" role="button" tabindex="0" aria-label="Close modal">&times;</span>
                <h2>Theme Settings</h2>
            </div>
            <div class="modal-body">
                <button class="theme-btn" data-theme="default">Dark Purple</button>
                <button class="theme-btn" data-theme="amoled">AMOLED Black</button>
                <button class="theme-btn" data-theme="light">Light Mode</button>
                <button class="theme-btn" data-theme="gold-black">Gold & Black</button>
            </div>
        </div>
    </div>
    <div id="logout-confirm-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header" style="padding-bottom: 0;">
                <span class="modal-close-btn" id="logout-modal-close-btn" role="button" tabindex="0" aria-label="Close modal">&times;</span>
                <h2>Logout Confirmation</h2>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to logout from the app?</p>
                <div class="modal-actions">
                    <button id="cancel-logout-btn">Cancel</button>
                    <button id="confirm-logout-btn">Logout</button>
                </div>
            </div>
        </div>
    </div>
    <div id="edit-bio-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <span class="modal-close-btn" role="button" tabindex="0" aria-label="Close modal">&times;</span>
                <h2>Edit Bio</h2>
            </div>
            <div class="modal-body">
                <form id="edit-bio-form" class="modal-form">
                    <div class="form-group">
                        <label for="bio-input" class="hidden">Your Bio</label>
                        <textarea id="bio-input" maxlength="100" placeholder="Enter your bio (max 100 characters)"></textarea>
                    </div>
                    <button type="submit">Save Bio</button>
                </form>
            </div>
        </div>
    </div>

    <div id="toast-container"></div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script>
        // --- The JavaScript part remains the same as the previous correct version ---
        // ... (copy and paste the entire <script> block from the previous response) ...
        // --- CONFIGURATION & GLOBAL VARS ---
        const firebaseConfig = { apiKey: "AIzaSyCRdgBnpDGvYVODyoTk5qUSbSHSj6kFneg", authDomain: "tournament-suman.firebaseapp.com", databaseURL: "https://tournament-suman-default-rtdb.asia-southeast1.firebasedatabase.app", projectId: "tournament-suman", storageBucket: "tournament-suman.firebasestorage.app", messagingSenderId: "29834441269", appId: "1:29834441269:web:2ee0d2f4c2c4a06e82f77c", measurementId: "G-R8P2GFB3B2" };
        const IMGBB_API_KEY = "3cc9a26ccdb87dd2937d610092f989cf";
        const DEFAULT_PROFILE_PIC_URL = "https://i.ibb.co/kg3pNBYp/5ed1a03049fcf64db0712bdca67c9390.jpg";
        const CUSTOM_MATCHES_COLLECTION = "customMatches";
        const REFERRAL_BONUS_AMOUNT = 10;
        
        // NEW: Spin Wheel Rewards Configuration
        const SPIN_WHEEL_REWARDS = [
            { type: 'coins', value: 5, label: '5 Coins' },
            { type: 'text', value: 'Try Again', label: 'Try Again' },
            { type: 'coins', value: 2, label: '2 Coins' },
            { type: 'coins', value: 10, label: '10 Coins' },
            { type: 'text', value: 'Free Like', label: '1 Free Like' },
            { type: 'coins', value: 1, label: '1 Coin' },
            { type: 'coins', value: 20, label: 'JACKPOT! 20' },
            { type: 'coins', value: 3, label: '3 Coins' },
        ];
        let isSpinAvailable = false;


        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        let userDocListener = null, notificationsListener = null, transactionHistoryListener = null;
        let matchesListener = null, historyMatchesListener = null, chatListener = null;
        let leaderboardListener = null, customMatchesListener = null, myCustomMatchesListener = null;
        let dashboardUpcomingListener = null, dashboardOngoingListener = null;
        let whatsappAdminNumber = null, currentlyInspectingUserId = null;
        let activeCountdownIntervals = [];
        let initialDocCheckComplete = false;
        let navigationHistory = [];
        let lastBackPressTime = 0;
        const EXIT_CONFIRMATION_THRESHOLD = 2500;

        // --- CORE FUNCTIONS ---
        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            if(!container) { console.warn("Toast container not found, cannot show toast:", message); return; }
            const toast = document.createElement('div'); toast.className = `toast ${type}`;
            toast.textContent = message; container.appendChild(toast);
            setTimeout(() => { toast.classList.add('hide'); }, 3000);
            setTimeout(() => { toast.remove(); }, 3500);
        }

        function applyTheme(themeName) {
            document.documentElement.setAttribute('data-theme', themeName);
            localStorage.setItem('selectedTheme', themeName);
            document.querySelectorAll('#theme-settings-modal .theme-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.theme === themeName);
            });
            console.log("Theme applied:", themeName);
        }

        function loadSavedTheme() {
            const savedTheme = localStorage.getItem('selectedTheme') || 'amoled';
            applyTheme(savedTheme);
        }

        function getDeviceId() {
            let deviceId = localStorage.getItem('device_id');
            if (!deviceId) {
                deviceId = 'dev_' + Date.now() + Math.random().toString(36).substring(2, 15);
                localStorage.setItem('device_id', deviceId);
            }
            return deviceId;
        }

        function timeAgo(timestamp) {
            if (!timestamp || !timestamp.toDate) return "Just now"; const now = new Date(); const secondsPast = (now.getTime() - timestamp.toDate().getTime()) / 1000;
            if (secondsPast < 60) return `${Math.round(secondsPast)}s ago`; if (secondsPast < 3600) return `${Math.round(secondsPast / 60)}m ago`;
            if (secondsPast < 86400) return `${Math.round(secondsPast / 3600)}h ago`; const daysPast = Math.round(secondsPast / 86400);
            if (daysPast === 1) return `Yesterday`; if (daysPast < 7) return `${daysPast}d ago`;
            return timestamp.toDate().toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }

        function sanitizeForHTML(str) {
            if (typeof str !== 'string') return '';
            const temp = document.createElement('div');
            temp.textContent = str;
            return temp.innerHTML;
        }

        function sanitizeIgnForDisplay(ign) {
            if (!ign) return '';
            return ign.replace(/[^\p{L}\p{N}\s_.-]/gu, '').trim();
        }

        // --- INITIALIZATION & AUTH STATE ---
        const loadingOverlay = document.getElementById('loading-overlay');
        
        auth.onAuthStateChanged(user => {
            console.log("onAuthStateChanged triggered. User:", user ? user.uid : null);
            const authWrapper = document.getElementById('auth-wrapper');
            const appWrapper = document.getElementById('app-wrapper');
            const loginContainer = document.getElementById("login-container");
            const registerContainer = document.getElementById("register-container");
            const authMessageDiv = document.getElementById("auth-message");
            initialDocCheckComplete = false;

            if (user) {
                console.log("User is LOGGED IN:", user.uid);
                if (authWrapper) authWrapper.classList.add('hidden');
                if (appWrapper) appWrapper.classList.remove('hidden');
                initializeApp(user);
            } else {
                console.log("User is LOGGED OUT or no user.");
                if (appWrapper) appWrapper.classList.add('hidden');
                if (authWrapper) authWrapper.classList.remove('hidden');

                if (loginContainer) loginContainer.classList.remove('hidden');
                if (registerContainer) registerContainer.classList.add('hidden');
                if (document.getElementById("login-email")) document.getElementById("login-email").focus();
                if (authMessageDiv) {
                   authMessageDiv.className = 'auth-message';
                   authMessageDiv.textContent = '';
                }
                navigationHistory = [];

                if (userDocListener) { userDocListener(); userDocListener = null; }
                if (notificationsListener) { notificationsListener(); notificationsListener = null; }
                if (transactionHistoryListener) { transactionHistoryListener(); transactionHistoryListener = null; }
                if (matchesListener) { matchesListener(); matchesListener = null; }
                if (historyMatchesListener) { historyMatchesListener(); historyMatchesListener = null; }
                if (chatListener) { chatListener(); chatListener = null; }
                if (leaderboardListener) { leaderboardListener(); leaderboardListener = null; }
                if (customMatchesListener) { customMatchesListener(); customMatchesListener = null; }
                if (myCustomMatchesListener) { myCustomMatchesListener(); myCustomMatchesListener = null; }
                if (dashboardUpcomingListener) { dashboardUpcomingListener(); dashboardUpcomingListener = null; }
                if (dashboardOngoingListener) { dashboardOngoingListener(); dashboardOngoingListener = null; }
                clearAllCountdowns();
                console.log("All page-specific listeners detached and countdowns cleared on logout.");
                if (loadingOverlay) loadingOverlay.style.display = 'none';
            }
        });

        document.addEventListener('DOMContentLoaded', () => {
            loadSavedTheme();
            handleAuthForms();
            setupThemeModalListeners();
            setupLogoutConfirmModalListeners();
            setupEditBioModalListeners(); 
            document.querySelectorAll('span[role="button"], div[role="button"], button[role="button"]').forEach(el => {
                el.addEventListener('keydown', (e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); el.click();}});
            });
        });

        function initializeApp(user) {
            console.log("Initializing app for user:", user.uid);
            loadAppSettings();
            setupStaticListeners(user);
            setupProfilePageListeners(user);
            setupBottomNav(user);
            setupGameTypeTabs();
            setupInspectModalListeners();
            setupHardwareBackButtonListener();

            // NEW: Initialize new features
            setupSpinWheel();
            setupSpinWheelListeners();
            checkSpinAvailability();
            checkLoginStreak(user);


            const dashboardPage = document.getElementById('dashboard-page');
            if (navigationHistory.length === 0) {
                 console.log("Fresh app start or login, loading dashboard.");
                 loadPageContent('dashboard-page', user);
            } else if (dashboardPage && !dashboardPage.classList.contains('active')) {
                const lastPage = navigationHistory[navigationHistory.length -1] || 'dashboard-page';
                console.log("Resuming to last known page or dashboard:", lastPage);
                loadPageContent(lastPage, user);
            } else {
                 console.log("App initialized, already on a page or dashboard was last.");
            }
        }

        // --- EVENT LISTENERS SETUP ---
        function setupStaticListeners(user) {
            console.log("Setting up static listeners for user:", user.uid);
            document.getElementById('profile-logout-btn-header').onclick = () => {
                 document.getElementById('logout-confirm-modal')?.classList.remove('hidden');
            };

            const notificationBtn = document.getElementById('notification-btn');
            if (notificationBtn) {
                notificationBtn.onclick = () => {
                    document.getElementById('notification-panel')?.classList.remove('hidden');
                    db.collection('users').doc(user.uid).collection('notifications').where('read', '==', false).get().then(snapshot => {
                        const batch = db.batch(); snapshot.forEach(docSnap => batch.update(docSnap.ref, { read: true })); batch.commit();
                    }).catch(err => console.error("Error marking notifications as read:", err));
                    document.getElementById('notification-dot')?.classList.add('hidden');
                };
            }

            document.querySelectorAll('.modal-overlay .modal-close-btn').forEach(btn => {
                if (!btn._hasClickListener) {
                    btn.onclick = () => btn.closest('.modal-overlay').classList.add('hidden');
                    btn._hasClickListener = true;
                }
            });

            const claimReferralBtn = document.getElementById('claim-referral-btn');
            if(claimReferralBtn) {
                claimReferralBtn.onclick = () => {
                    const enteredCode = prompt("Enter the referral code you received:");
                    if(enteredCode && enteredCode.trim() !== "") {
                        processReferralCode(enteredCode.trim().toUpperCase());
                    }
                }
            }

            setupWalletModal(user);

            const createChallengeRulesLink = document.getElementById('create-challenge-rules-link');
            if(createChallengeRulesLink) {
               createChallengeRulesLink.onclick = (e) => { e.preventDefault(); updateRulesModalWhatsAppLink(); document.getElementById('rules-modal')?.classList.remove('hidden');}
            }

            const updateRoomForm = document.getElementById('update-room-form');
            if (updateRoomForm) {
                updateRoomForm.addEventListener('submit', updateChallengeRoomDetails);
            }

            const headerWalletDiv = document.querySelector('.app-header .wallet');
            if (headerWalletDiv) {
               headerWalletDiv.onclick = () => {
                   const walletModal = document.getElementById('wallet-modal');
                   if (walletModal) {
                       walletModal.classList.remove('hidden');
                       const addMoneyTabLink = document.querySelector('#wallet-tabs a[data-tab="add-money"]');
                       if (addMoneyTabLink) addMoneyTabLink.click();
                   }
               };
            }

            if (userDocListener) { console.log("Detaching existing userDocListener before attaching new one."); userDocListener(); userDocListener = null; }
            console.log("Attaching new userDocListener for UID:", user.uid);
            userDocListener = db.collection('users').doc(user.uid).onSnapshot(doc => {
                if (doc.exists) {
                    console.log("User document data received for UID:", user.uid, doc.data());
                    const userData = doc.data();
                    updateProfileUI(userData, user); 
                    
                    const referralBanner = document.getElementById('referral-banner');
                    if (referralBanner) {
                        referralBanner.classList.toggle('hidden', !!userData.referredBy);
                    }
                    
                    const profilePage = document.getElementById('profile-page');
                    if (profilePage && profilePage.classList.contains('active')) {
                        const otherUserActions = document.getElementById('profile-actions-container');
                        if (otherUserActions && otherUserActions.classList.contains('hidden')) {
                            console.log("Own profile active, re-rendering graphs on data update.");
                            renderPlayerGraphs(userData);
                        }
                    }

                    if (!initialDocCheckComplete) {
                        initialDocCheckComplete = true;
                        if (loadingOverlay) loadingOverlay.style.display = 'none';
                    }
                } else {
                    if (!initialDocCheckComplete && user.metadata.creationTime === user.metadata.lastSignInTime) {
                        console.warn(`User document for NEW USER ${user.uid} not found on initial snapshot. Listener will retry.`);
                    } else {
                        console.error("User document critical issue for UID:", user.uid);
                        showToast("Error: Your user data is missing. Logging out.", "error");
                        if (loadingOverlay) loadingOverlay.style.display = 'none';
                        auth.signOut().then(() => window.location.reload());
                    }
                }
            }, err => {
                console.error("Error listening to user document:", err);
                showToast("Error fetching user data. Logging out.", "error");
                if (loadingOverlay) loadingOverlay.style.display = 'none';
                auth.signOut().then(() => window.location.reload());
            });

            if (notificationsListener) {console.log("Detaching existing notificationsListener."); notificationsListener(); notificationsListener = null;}
            console.log("Attaching new notificationsListener for UID:", user.uid);
            notificationsListener = db.collection('users').doc(user.uid).collection('notifications').orderBy('timestamp', 'desc').limit(20).onSnapshot(snapshot => {
                  const listEl = document.getElementById('notification-list'); if(!listEl) return; listEl.innerHTML = ''; let unreadCount = 0;
                  if(snapshot.empty) { listEl.innerHTML = '<p style="padding:20px;text-align:center;">No notifications.</p>'; }
                  else { snapshot.forEach(docSnap => { const notif = docSnap.data(); if (!notif.read) unreadCount++; const itemClass = notif.type === 'error' ? 'error' : ''; listEl.innerHTML += `<div class="notification-item ${itemClass}"><p>${sanitizeForHTML(notif.message)}</p><div class="timestamp">${timeAgo(notif.timestamp)}</div></div>`; });}
                  document.getElementById('notification-dot')?.classList.toggle('hidden', unreadCount === 0);
            }, err => { console.error("Error listening to notifications:", err);});
        }
        
        function setupProfilePageListeners(user) {
            document.getElementById('pfp-upload')?.addEventListener('change', e => uploadProfilePicture(e, user));
            document.getElementById('copy-ref-btn')?.addEventListener('click', copyReferralCode);
            document.getElementById('profile-save-btn')?.addEventListener('click', () => saveProfileDetails(user));
            document.getElementById('edit-bio-btn')?.addEventListener('click', async () => {
                try {
                    const userDoc = await db.collection('users').doc(user.uid).get();
                    openBioEditor(userDoc.exists ? userDoc.data().bio : "");
                } catch(error) {
                    console.error("Error fetching bio:", error);
                    openBioEditor(""); 
                }
            });
            document.getElementById('game-rules-btn')?.addEventListener('click', () => {
                updateRulesModalWhatsAppLink(); document.getElementById('rules-modal')?.classList.remove('hidden');
            });
            document.getElementById('profile-settings-btn-header')?.addEventListener('click', () => {
                document.getElementById('theme-settings-modal')?.classList.remove('hidden');
                const currentTheme = localStorage.getItem('selectedTheme') || 'default';
                 document.querySelectorAll('#theme-settings-modal .theme-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.theme === currentTheme);
                });
            });
        }

        function setupThemeModalListeners() {
            document.querySelectorAll('#theme-settings-modal .theme-btn').forEach(button => {
                button.addEventListener('click', () => {
                    applyTheme(button.dataset.theme);
                });
            });
        }

        function setupEditBioModalListeners() {
            const modal = document.getElementById('edit-bio-modal');
            const bioInput = document.getElementById('bio-input');
            const bioForm = document.getElementById('edit-bio-form');
            if (!modal || !bioInput || !bioForm) return;
            modal.querySelector('.modal-close-btn').onclick = () => modal.classList.add('hidden');
            bioForm.onsubmit = async (e) => {
                e.preventDefault();
                const newBio = bioInput.value.trim();
                const currentUser = auth.currentUser;
                if (!currentUser) { showToast("Please log in to update your bio.", "error"); return; }
                try {
                    await db.collection('users').doc(currentUser.uid).update({ bio: newBio });
                    showToast("Bio updated!", "success");
                    modal.classList.add('hidden');
                } catch (error) {
                    console.error("Error updating bio:", error);
                    showToast("Failed to update bio.", "error");
                }
            };
        }

        function setupGameTypeTabs() {
            const gameTypeTabsContainer = document.getElementById('game-type-tabs');
            if (gameTypeTabsContainer) {
                gameTypeTabsContainer.addEventListener('click', e => {
                    if (e.target.tagName === 'A' && e.target.dataset.gametype) {
                        const user = auth.currentUser; if (!user) return;
                        const currentActiveGameTab = gameTypeTabsContainer.querySelector('a.active');
                        if (currentActiveGameTab) currentActiveGameTab.classList.remove('active');
                        e.target.classList.add('active');
                        const currentStatusTab = document.querySelector('#match-status-tabs a.active');
                        if (currentStatusTab && currentStatusTab.dataset.status) {
                            loadMatchesByGameAndStatus(user.uid, e.target.dataset.gametype, currentStatusTab.dataset.status);
                        }
                    }
                });
            }
        }

        function setupBottomNav(user) {
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => {
                item.addEventListener('click', e => {
                    e.preventDefault();
                    const targetPage = item.dataset.page;
                    const triggerModal = item.dataset.trigger;
                    if (triggerModal) {
                        const modalElement = document.getElementById(triggerModal);
                        if (modalElement) {
                            if (triggerModal === 'rules-modal') updateRulesModalWhatsAppLink();
                            modalElement.classList.remove('hidden');
                        }
                        return;
                    }
                    if (targetPage) { loadPageContent(targetPage, user); }
                });
            });

            const matchStatusTabs = document.getElementById('match-status-tabs');
            if (matchStatusTabs) {
                matchStatusTabs.addEventListener('click', e => {
                    if(e.target.tagName === 'A' && e.target.dataset.status){
                        const user = auth.currentUser; if (!user) return;
                        document.querySelectorAll('#match-status-tabs a').forEach(t => t.classList.remove('active'));
                        e.target.classList.add('active');
                        const currentGameTypeTab = document.querySelector('#game-type-tabs a.active');
                        if (currentGameTypeTab && currentGameTypeTab.dataset.gametype) {
                            loadMatchesByGameAndStatus(user.uid, currentGameTypeTab.dataset.gametype, e.target.dataset.status);
                        }
                    }
                });
            }
        }

        function setupLogoutConfirmModalListeners() {
            const logoutModal = document.getElementById('logout-confirm-modal');
            const confirmBtn = document.getElementById('confirm-logout-btn');
            const cancelBtn = document.getElementById('cancel-logout-btn');
            const closeBtn = document.getElementById('logout-modal-close-btn');

            if(confirmBtn) confirmBtn.onclick = () => {
                console.log("Logout confirmed via modal. Signing out...");
                if (document.activeElement) document.activeElement.blur();
                if (logoutModal) logoutModal.classList.add('hidden'); 
                auth.signOut().catch(error => {
                    console.error("Firebase signOut error:", error);
                    showToast("Logout failed: " + error.message, "error");
                });
            };
            if(cancelBtn) cancelBtn.onclick = () => { if(logoutModal) logoutModal.classList.add('hidden'); };
            if(closeBtn) closeBtn.onclick = () => { if(logoutModal) logoutModal.classList.add('hidden'); };
        }

        function setupHardwareBackButtonListener() {
            window.addEventListener('popstate', handleBackButtonPress);
            console.log("Hardware back button listener setup (using popstate).");
        }


        // --- NAVIGATION & PAGE LOADING ---
        function handleBackButtonPress(event) {
            console.log("Back button pressed. Current history:", JSON.stringify(navigationHistory));
            const appWrapper = document.getElementById('app-wrapper');
            if (appWrapper && appWrapper.classList.contains('hidden')) {
                console.log("Auth wrapper visible, allowing default back behavior.");
                return;
            }
            const openModal = document.querySelector('.modal-overlay:not(.hidden)');
            if (openModal) {
                console.log("Closing open modal:", openModal.id);
                openModal.classList.add('hidden');
                history.pushState(null, '', location.href); 
                return;
            }
            if (navigationHistory.length > 1) {
                navigationHistory.pop();
                const previousPageId = navigationHistory[navigationHistory.length - 1];
                console.log("Navigating back to:", previousPageId);
                if (auth.currentUser && previousPageId) {
                    const navItem = document.querySelector(`.nav-item[data-page="${previousPageId}"]`);
                    if (navItem) { navItem.click(); } 
                    else { loadPageContent('dashboard-page', auth.currentUser); }
                } else if (auth.currentUser) {
                     loadPageContent('dashboard-page', auth.currentUser);
                }
            } else {
                const currentTime = new Date().getTime();
                if (currentTime - lastBackPressTime < EXIT_CONFIRMATION_THRESHOLD) {
                    console.log("Second back press within threshold. Allowing exit/default back.");
                    if (navigator.app && navigator.app.exitApp) { navigator.app.exitApp(); } 
                    else { window.history.back(); }
                } else {
                    showToast("Press back again to exit", "warning");
                    lastBackPressTime = currentTime;
                    console.log("First back press for exit. Set lastBackPressTime.");
                    history.pushState(null, '', location.href);
                }
            }
        }

        function loadPageContent(pageId, user, targetProfileUserId = null) {
            console.log("Loading page content for:", pageId, "User:", user ? user.uid : 'null', "TargetProfile:", targetProfileUserId || 'null');

            if (navigationHistory[navigationHistory.length - 1] !== pageId) {
                const mainPages = ['dashboard-page', 'matches-page', 'custom-matches-page', 'leaderboard-page', 'chat-page', 'profile-page'];
                if (mainPages.includes(pageId)) {
                     navigationHistory.push(pageId);
                     history.pushState({page: pageId}, '', `#${pageId}`);
                     console.log("Pushed to history:", pageId, "History now:", navigationHistory);
                }
            }
            if (navigationHistory.length > 10) { navigationHistory.shift(); }

            document.querySelectorAll('.page').forEach(p => {
                p.classList.remove('active');
                p.style.display = 'none';
            });

            const pageElement = document.getElementById(pageId);
            if(pageElement) {
                pageElement.style.display = '';
                pageElement.classList.add('active');
            } else { console.error(`Page with ID ${pageId} not found.`); return; }

            const navItem = document.querySelector(`.nav-item[data-page="${pageId}"]`);
            if (navItem) {
                document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                navItem.classList.add('active');
                const titleSpan = navItem.querySelector('span:last-child');
                if (titleSpan) document.getElementById('header-title').textContent = titleSpan.textContent.toUpperCase();
            } else if (pageId === 'profile-page' && targetProfileUserId) {
                document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                document.getElementById('header-title').textContent = "VIEW PROFILE";
            }

            const detachAllListeners = () => {
                if (matchesListener) { matchesListener(); matchesListener = null; }
                if (historyMatchesListener) { historyMatchesListener(); historyMatchesListener = null; }
                if (chatListener) { chatListener(); chatListener = null; }
                if (leaderboardListener) { leaderboardListener(); leaderboardListener = null; }
                if (customMatchesListener) { customMatchesListener(); customMatchesListener = null; }
                if (myCustomMatchesListener) { myCustomMatchesListener(); myCustomMatchesListener = null; }
                if (dashboardUpcomingListener) { dashboardUpcomingListener(); dashboardUpcomingListener = null; }
                if (dashboardOngoingListener) { dashboardOngoingListener(); dashboardOngoingListener = null; }
                clearAllCountdowns();
            };
            detachAllListeners();

            switch (pageId) {
                case 'dashboard-page': loadDashboardContent(user); break;
                case 'profile-page': loadProfilePageAndUpdateUI(user, targetProfileUserId); break;
                case 'matches-page':
                    const activeGameTab = document.querySelector('#game-type-tabs a.active') || document.querySelector('#game-type-tabs a');
                    const activeStatusTab = document.querySelector('#match-status-tabs a.active') || document.querySelector('#match-status-tabs a');
                    if (activeGameTab && activeGameTab.dataset.gametype && activeStatusTab && activeStatusTab.dataset.status) {
                         loadMatchesByGameAndStatus(user.uid, activeGameTab.dataset.gametype, activeStatusTab.dataset.status);
                    } else {
                        document.querySelector('#game-type-tabs a[data-gametype="FREEFIRE"]')?.click();
                    }
                    break;
                case 'history-page': loadHistoryMatches(user.uid); break;
                case 'chat-page': loadChatMessages(user); break;
                case 'leaderboard-page': loadLeaderboard(); break;
                case 'custom-matches-page':
                    const activeCustomTab = document.querySelector('#custom-match-main-tabs a.active') || document.querySelector('#custom-match-main-tabs a[data-subpage="join-custom-match"]');
                    if (activeCustomTab) { handleCustomMatchMainTabSwitch(activeCustomTab.dataset.subpage); }
                    else { handleCustomMatchMainTabSwitch('join-custom-match');}
                    setupCustomMatchPageListeners();
                    break;
                default: console.warn("Unknown pageId in loadPageContent:", pageId);
            }
        }

        function renderSkeletonCard(container, count = 3, isHorizontal = false) {
            if (!container) return;
            container.innerHTML = '';
            for (let i = 0; i < count; i++) {
                const skeleton = document.createElement('div');
                skeleton.className = 'skeleton-card';
                if(isHorizontal) {
                    skeleton.style.minWidth = '220px';
                    skeleton.style.flexShrink = '0';
                    skeleton.style.marginBottom = '0';
                }
                container.appendChild(skeleton);
            }
        }
        
        // --- NEW & UPDATED FEATURE-SPECIFIC FUNCTIONS ---

        function setupSpinWheel() {
            const wheel = document.getElementById('spin-wheel');
            if (!wheel) return;
            wheel.innerHTML = '';
            const segmentAngle = 360 / SPIN_WHEEL_REWARDS.length;
            const colors = ['#6a11cb', '#2575fc', '#ff7e5f', '#feb47b', '#1fbf73', '#8e44ad', '#e74c3c', '#3498db'];

            SPIN_WHEEL_REWARDS.forEach((reward, index) => {
                const segment = document.createElement('div');
                segment.className = 'wheel-segment';
                const rotation = segmentAngle * index;
                segment.style.transform = `rotate(${rotation}deg) skewX(${90 - segmentAngle}deg)`;
                segment.style.backgroundColor = colors[index % colors.length];
                
                const textSpan = document.createElement('span');
                textSpan.textContent = reward.label.replace(' ', '\n');
                segment.appendChild(textSpan);
                wheel.appendChild(segment);
            });
        }

        async function checkSpinAvailability() {
            const user = auth.currentUser;
            if (!user) return;
            const banner = document.getElementById('spin-wheel-banner');
            try {
                const userDoc = await db.collection('users').doc(user.uid).get();
                const userData = userDoc.data();
                const lastSpinTime = userData.lastSpinTime ? userData.lastSpinTime.toDate() : null;
                
                if (!lastSpinTime || (new Date().getTime() - lastSpinTime.getTime()) >= 24 * 60 * 60 * 1000) {
                    isSpinAvailable = true;
                    if(banner) banner.classList.remove('hidden');
                } else {
                    isSpinAvailable = false;
                    if(banner) banner.classList.add('hidden');
                }
            } catch(e) { console.error("Error checking spin availability", e); }
        }

        function setupSpinWheelListeners() {
            const spinBanner = document.getElementById('spin-wheel-banner');
            const spinModal = document.getElementById('spin-wheel-modal');
            const spinBtn = document.getElementById('spin-btn');

            if(spinBanner) spinBanner.onclick = () => {
                if (isSpinAvailable) {
                    document.getElementById('spin-result-text').textContent = '';
                    if(spinModal) spinModal.classList.remove('hidden');
                } else {
                    showToast("Aap apna agla spin kal istemal kar sakte hain!", "warning");
                }
            };

            if(spinBtn) spinBtn.onclick = async () => {
                if (!isSpinAvailable) return;
                spinBtn.disabled = true;
                isSpinAvailable = false; 
                document.getElementById('spin-wheel-banner')?.classList.add('hidden');

                const wheel = document.getElementById('spin-wheel');
                const segmentAngle = 360 / SPIN_WHEEL_REWARDS.length;
                const randomStopIndex = Math.floor(Math.random() * SPIN_WHEEL_REWARDS.length);
                const stopAngle = (randomStopIndex * segmentAngle);
                const centeredStopAngle = stopAngle + (segmentAngle / 2) - (360 / (SPIN_WHEEL_REWARDS.length * 2)); // Adjust to center the pointer
                const extraRotations = 360 * 5;
                const totalRotation = extraRotations + centeredStopAngle;
                
                wheel.style.transform = `rotate(${totalRotation}deg)`;

                setTimeout(async () => {
                    const reward = SPIN_WHEEL_REWARDS[randomStopIndex];
                    document.getElementById('spin-result-text').textContent = `Congratulations! You won: ${reward.label}`;
                    
                    const userRef = db.collection('users').doc(auth.currentUser.uid);
                    await userRef.update({ lastSpinTime: firebase.firestore.FieldValue.serverTimestamp() });

                    if (reward.type === 'coins') {
                        await userRef.update({ depositWallet: firebase.firestore.FieldValue.increment(reward.value) });
                        showToast(`${reward.value} Coins added to your wallet!`, 'success');
                    } else if (reward.type === 'text' && reward.value === 'Free Like') {
                        // Implement free like logic if needed
                        showToast('You got a Free Like token!', 'success');
                    }
                    
                    spinBtn.disabled = false;
                    setTimeout(() => spinModal?.classList.add('hidden'), 2000);
                }, 5500);
            };
        }

        async function checkLoginStreak(user) {
            if(!user) return;
            const userRef = db.collection('users').doc(user.uid);
            try {
                const doc = await userRef.get();
                if (!doc.exists) return;

                const userData = doc.data();
                const streakContainer = document.getElementById('streak-container');
                const streakCountEl = document.getElementById('streak-count');
                
                const now = new Date();
                const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());

                const lastLogin = userData.lastLoginDate ? userData.lastLoginDate.toDate() : null;
                let lastLoginDay = null;
                if(lastLogin) {
                    lastLoginDay = new Date(lastLogin.getFullYear(), lastLogin.getMonth(), lastLogin.getDate());
                }

                let currentStreak = userData.loginStreak || 0;
                
                if (!lastLoginDay || lastLoginDay.getTime() < today.getTime()) {
                    const yesterday = new Date(today);
                    yesterday.setDate(yesterday.getDate() - 1);

                    if (lastLoginDay && lastLoginDay.getTime() === yesterday.getTime()) {
                        currentStreak++;
                    } else {
                        currentStreak = 1;
                    }
                    
                    await userRef.update({
                        loginStreak: currentStreak,
                        lastLoginDate: firebase.firestore.FieldValue.serverTimestamp()
                    });

                    if (currentStreak > 1) {
                        showToast(`Login streak: Day ${currentStreak}! Keep it up!`, 'success');
                    }
                }

                if (currentStreak > 0) {
                    streakCountEl.textContent = currentStreak;
                    streakContainer.classList.remove('hidden');
                } else {
                    streakContainer.classList.add('hidden');
                }

            } catch (error) {
                console.error("Error checking login streak:", error);
            }
        }
        
        function renderPlayerGraphs(userData) {
            const performanceSection = document.querySelector('.profile-performance-section');
            const winLossCtx = document.getElementById('winLossChart')?.getContext('2d');
            const kdCtx = document.getElementById('killDeathChart')?.getContext('2d');
            
            if(window.myWinLossChart) window.myWinLossChart.destroy();
            if(window.myKillDeathChart) window.myKillDeathChart.destroy();

            if (!performanceSection || !winLossCtx || !kdCtx || !userData.matchHistory || !Array.isArray(userData.matchHistory) || userData.matchHistory.length === 0) {
                 console.log("Not enough data to render charts or elements not found.");
                 if(performanceSection) performanceSection.style.display = 'none';
                 return;
            }
            performanceSection.style.display = 'block';

            const matchHistory = userData.matchHistory;
            const wins = matchHistory.filter(m => m.won).length;
            const losses = matchHistory.length - wins;
            const kills = matchHistory.map(m => m.kills || 0);
            const matchLabels = matchHistory.slice(-10).map((_, i) => `M${matchHistory.length - 9 + i}`); // Show last 10 matches label

            window.myWinLossChart = new Chart(winLossCtx, {
                type: 'pie',
                data: {
                    labels: ['Wins', 'Losses'],
                    datasets: [{
                        label: 'Match Outcomes',
                        data: [wins, losses],
                        backgroundColor: [ 'rgba(31, 191, 115, 0.7)', 'rgba(233, 66, 84, 0.7)' ],
                        borderColor: 'var(--secondary-bg)',
                        borderWidth: 2
                    }]
                },
                options: { responsive: true, plugins: { legend: { labels: { color: 'var(--text-secondary)' } }, title: { display: true, text: 'Win/Loss Ratio', color: 'var(--text-primary)' } } }
            });

            window.myKillDeathChart = new Chart(kdCtx, {
                type: 'line',
                data: {
                    labels: matchLabels,
                    datasets: [{
                        label: 'Kills per Match',
                        data: kills.slice(-10), // Show last 10 matches data
                        fill: true,
                        backgroundColor: 'rgba(255, 193, 7, 0.2)',
                        borderColor: 'var(--coin-gold)',
                        tension: 0.2
                    }]
                },
                options: { responsive: true, plugins: { legend: { display: false }, title: { display: true, text: 'Recent Match Kills (Last 10)', color: 'var(--text-primary)' } },
                    scales: { y: { ticks: { color: 'var(--text-tertiary)', stepSize: 1 }, grid: { color: 'rgba(255,255,255,0.1)' } }, x: { ticks: { color: 'var(--text-tertiary)' }, grid: { display: false } } }
                }
            });
        }
        
        async function processReferralCode(enteredCode) {
            const currentUser = auth.currentUser;
            if (!currentUser) {
                showToast("You need to be logged in.", "error");
                return;
            }

            const userRef = db.collection('users').doc(currentUser.uid);
            
            try {
                const userDoc = await userRef.get();
                if (!userDoc.exists) throw new Error("Your user data could not be found.");
                if (userDoc.data().referredBy) {
                    showToast("You have already used a referral code.", "warning");
                    return;
                }
                if (userDoc.data().referralCode === enteredCode) {
                    showToast("You cannot use your own referral code.", "error");
                    return;
                }
                const deviceId = getDeviceId();
                const deviceQuery = await db.collection('users').where('registeredFromDeviceId', '==', deviceId).where('referredBy', '!=', null).limit(1).get();

                if (!deviceQuery.empty) {
                    showToast("Referral bonus has already been claimed on this device.", "error");
                    return;
                }

                const referrerQuery = await db.collection('users').where('referralCode', '==', enteredCode).limit(1).get();
                if (referrerQuery.empty) {
                    showToast("Invalid referral code.", "error");
                    return;
                }

                const referrerDoc = referrerQuery.docs[0];
                const referrerId = referrerDoc.id;
                const referrerIgn = sanitizeIgnForDisplay(referrerDoc.data().ign || "A player");

                await db.runTransaction(async (t) => {
                    t.update(userRef, {
                        depositWallet: firebase.firestore.FieldValue.increment(REFERRAL_BONUS_AMOUNT),
                        referredBy: referrerId,
                        registeredFromDeviceId: deviceId 
                    });
                    t.update(referrerDoc.ref, {
                        winningsWallet: firebase.firestore.FieldValue.increment(REFERRAL_BONUS_AMOUNT)
                    });
                });
                
                const currentUserIgn = sanitizeIgnForDisplay(userDoc.data().ign || 'A new player');
                const welcomeMessage = `Welcome! You received ${REFERRAL_BONUS_AMOUNT} coins for using ${referrerIgn}'s referral code.`;
                db.collection('users').doc(currentUser.uid).collection('notifications').add({
                    message: welcomeMessage, read: false, timestamp: firebase.firestore.FieldValue.serverTimestamp(), type: 'success'
                });
                
                const referrerMessage = `You earned ${REFERRAL_BONUS_AMOUNT} winning coins! ${currentUserIgn} used your referral code.`;
                 db.collection('users').doc(referrerId).collection('notifications').add({
                    message: referrerMessage, read: false, timestamp: firebase.firestore.FieldValue.serverTimestamp(), type: 'success'
                });

                showToast(`Success! ${REFERRAL_BONUS_AMOUNT} coins added to your wallet.`, "success");

            } catch (error) {
                console.error("Error processing referral code:", error);
                showToast(error.message || "An error occurred.", "error");
            }
        }


        // --- EXISTING CORE FUNCTIONS (No major changes needed below) ---
        async function loadAppSettings() {
            try {
                const doc = await db.collection('app-settings').doc('config').get();
                if (doc.exists) {
                    const settings = doc.data();
                    const qrImg = document.getElementById('upi-qr-code');
                    if (settings.qrCodeUrl && qrImg) qrImg.src = settings.qrCodeUrl;

                    if (settings.whatsappNumber) {
                        whatsappAdminNumber = settings.whatsappNumber;
                        const waLinkWithdraw = document.getElementById('whatsapp-link');
                        const waLinkAddMoney = document.getElementById('add-money-whatsapp-link');
                        if (waLinkWithdraw) waLinkWithdraw.href = `https://wa.me/${whatsappAdminNumber}`;
                        if (waLinkAddMoney) waLinkAddMoney.href = `https://wa.me/${whatsappAdminNumber}`;
                        updateRulesModalWhatsAppLink();

                        const dashboardWaLink = document.getElementById('dashboard-whatsapp-link');
                        if(dashboardWaLink) {
                            dashboardWaLink.href = settings.whatsappGroupLink || `https://wa.me/${settings.whatsappNumber}?text=Hello!+I+want+to+join+the+group.`;
                        }
                    }
                } else { console.log("App settings (config doc) not found."); }
            } catch (error) { console.error("Error loading app settings:", error); showToast("Could not load app settings.", "error"); }
        }

        function loadDashboardContent(user) {
            if (dashboardUpcomingListener) dashboardUpcomingListener();
            if (dashboardOngoingListener) dashboardOngoingListener();

            const upcomingContainer = document.getElementById('dashboard-upcoming-matches');
            const ongoingContainer = document.getElementById('dashboard-ongoing-matches');

            if (!upcomingContainer || !ongoingContainer) return;

            renderSkeletonCard(upcomingContainer, 3, true);
            renderSkeletonCard(ongoingContainer, 2, true);

            dashboardUpcomingListener = db.collection("tournaments").where("status", "==", "upcoming").orderBy("matchId", "desc").limit(5)
                .onSnapshot(snapshot => {
                    if(!upcomingContainer) return;
                    upcomingContainer.innerHTML = "";
                    if (snapshot.empty) {
                        upcomingContainer.innerHTML = `<p style="padding: 10px; color: var(--text-tertiary);">No upcoming tournaments.</p>`;
                    } else {
                        snapshot.forEach(doc => renderTournamentCard(upcomingContainer, doc.id, doc.data(), user.uid));
                    }
                }, err => {
                    console.error("Error loading dashboard upcoming matches:", err);
                    if(upcomingContainer) upcomingContainer.innerHTML = `<p>Could not load matches.</p>`;
                });

            dashboardOngoingListener = db.collection("tournaments").where("status", "==", "ongoing").orderBy("matchId", "desc").limit(5)
                .onSnapshot(snapshot => {
                    if(!ongoingContainer) return;
                    ongoingContainer.innerHTML = "";
                    if (snapshot.empty) {
                        ongoingContainer.innerHTML = `<p style="padding: 10px; color: var(--text-tertiary);">No ongoing tournaments.</p>`;
                    } else {
                        snapshot.forEach(doc => renderTournamentCard(ongoingContainer, doc.id, doc.data(), user.uid));
                    }
                }, err => {
                    console.error("Error loading dashboard ongoing matches:", err);
                    if(ongoingContainer) ongoingContainer.innerHTML = `<p>Could not load matches.</p>`;
                });

            const challengeLink = document.getElementById('dashboard-challenge-link');
            if (challengeLink) {
                challengeLink.onclick = (e) => {
                    e.preventDefault();
                    document.querySelector('.nav-item[data-page="custom-matches-page"]')?.click();
                };
            }

            document.querySelectorAll('.view-all-link').forEach(link => {
                link.onclick = (e) => {
                    e.preventDefault();
                    const targetPage = link.dataset.targetpage;
                    const targetStatus = link.dataset.status;
                    document.querySelector(`.nav-item[data-page="${targetPage}"]`)?.click();
                    setTimeout(() => {
                         const statusTab = document.querySelector(`#match-status-tabs a[data-status="${targetStatus}"]`);
                         if(statusTab) statusTab.click();
                    }, 100);
                }
            });
        }
        
        function updateProfileUI(userData, user) {
            if (!user) { console.warn("updateProfileUI called with null user."); return; }
            
            const sanitizedIgn = sanitizeIgnForDisplay(userData.ign || (user.email ? user.email.split('@')[0] : "User"));
            const badgeHTML = userData.badgeUrl ? `<img src="${userData.badgeUrl}" class="user-badge" alt="Badge">` : '';

            document.getElementById('header-wallet-balance').textContent = ((userData.depositWallet || 0) + (userData.winningsWallet || 0)).toFixed(2);
            document.getElementById('modal-wallet-balance').textContent = ((userData.depositWallet || 0) + (userData.winningsWallet || 0)).toFixed(2);
            document.getElementById('deposit-balance').textContent = (userData.depositWallet || 0).toFixed(2);
            document.getElementById('winnings-balance').textContent = (userData.winningsWallet || 0).toFixed(2);
            document.getElementById('profile-pic').src = userData.profilePicUrl || DEFAULT_PROFILE_PIC_URL;
            document.getElementById('profile-name').innerHTML = `${sanitizedIgn} ${badgeHTML}`;
            const profileBioElement = document.getElementById('profile-bio');
            let bioTextNode = profileBioElement.firstChild;
            if (!bioTextNode || bioTextNode.nodeType !== Node.TEXT_NODE) {
                bioTextNode = document.createTextNode('');
                profileBioElement.insertBefore(bioTextNode, profileBioElement.firstChild);
            }
            bioTextNode.nodeValue = (userData.bio || 'No bio set.') + ' ';
            document.getElementById('referral-code').textContent = userData.referralCode || 'N/A';
            document.getElementById('freefire-ign-input').value = userData.freefire_ign || '';
            const myProfileLikesCountTextEl = document.getElementById('my-profile-likes-count-text');
            if (myProfileLikesCountTextEl) {
                const likedByDetailsMap = userData.likedByDetails || {};
                myProfileLikesCountTextEl.textContent = `${Object.keys(likedByDetailsMap).length} Likes`;
            }
            document.getElementById('profile-actions-container')?.classList.add('hidden');
        }
        async function loadProfilePageAndUpdateUI(loggedInUser, targetUserId = null) {
            const userIdToLoad = targetUserId || loggedInUser.uid;
            const isOwnProfile = userIdToLoad === loggedInUser.uid;

            const performanceSection = document.querySelector('.profile-performance-section');

            document.getElementById('my-profile-likes-display-container').style.display = isOwnProfile ? 'flex' : 'none';
            document.getElementById('profile-actions-container').classList.toggle('hidden', isOwnProfile);
            document.getElementById('edit-bio-btn').style.display = isOwnProfile ? 'inline-block' : 'none';
            const pfpLabel = document.querySelector('label[for="pfp-upload"]');
            if (pfpLabel) pfpLabel.style.cursor = isOwnProfile ? 'pointer' : 'default';
            document.getElementById('pfp-upload').disabled = !isOwnProfile;
            document.querySelector('.game-ids-section').style.display = isOwnProfile ? 'flex' : 'none';
            document.getElementById('profile-logout-btn-header').style.display = isOwnProfile ? 'flex' : 'none';
            document.getElementById('profile-settings-btn-header').style.display = isOwnProfile ? 'flex' : 'none';
            document.querySelector('.profile-page-actions').style.display = isOwnProfile ? 'flex' : 'none';
            document.querySelector('.referral-box').style.display = isOwnProfile ? 'flex' : 'none';
            document.getElementById('profile-save-btn').style.display = isOwnProfile ? 'block' : 'none';
            
            if (performanceSection) {
                performanceSection.style.display = isOwnProfile ? 'block' : 'none';
            }


            try {
                const tournamentsSnapshot = await db.collection('tournaments').where("participants", "array-contains", userIdToLoad).get();
                const customMatchesSnapshot = await db.collection(CUSTOM_MATCHES_COLLECTION).where("playersArray", "array-contains", userIdToLoad).get();
                document.getElementById('matches-played').textContent = tournamentsSnapshot.size + customMatchesSnapshot.size;
                const userDoc = await db.collection('users').doc(userIdToLoad).get();
                if (userDoc.exists) {
                    const userData = userDoc.data();
                    const sanitizedIgn = sanitizeIgnForDisplay(userData.ign || (userData.email ? userData.email.split('@')[0] : "User"));
                    const badgeHTML = userData.badgeUrl ? `<img src="${userData.badgeUrl}" class="user-badge" alt="Badge">` : '';
                    document.getElementById('profile-pic').src = userData.profilePicUrl || DEFAULT_PROFILE_PIC_URL;
                    document.getElementById('profile-name').innerHTML = `${sanitizedIgn} ${badgeHTML}`;
                    const profileBioElement = document.getElementById('profile-bio');
                    let bioTextNode = profileBioElement.firstChild;
                     if (!bioTextNode || bioTextNode.nodeType !== Node.TEXT_NODE) {
                        bioTextNode = document.createTextNode('');
                        profileBioElement.insertBefore(bioTextNode, profileBioElement.firstChild);
                    }
                    bioTextNode.nodeValue = (userData.bio || (isOwnProfile ? 'No bio set.' : 'No bio available.')) + ' ';
                    const likedByDetailsMap = userData.likedByDetails || {};
                    const totalLikes = Object.keys(likedByDetailsMap).length;
                    document.getElementById('total-winnings').textContent = (userData.totalWinnings || 0).toFixed(2);
                    
                    if (isOwnProfile) {
                        renderPlayerGraphs(userData); // NEW: Render graphs for own profile
                        document.getElementById('my-profile-likes-count-text').textContent = `${totalLikes} Likes`;
                        document.getElementById('freefire-ign-input').value = userData.freefire_ign || '';
                        document.getElementById('referral-code').textContent = userData.referralCode || 'N/A';
                    } else {
                        document.getElementById('profile-settings-btn-header').style.display = 'none';
                        document.getElementById('profile-likes-count-on-others-page').querySelector('span:last-child').textContent = `${totalLikes} Likes`;
                        const likeBtnOnOthers = document.getElementById('like-profile-btn');
                        const likeBtnTextOnOthers = likeBtnOnOthers.querySelector('span:last-child');
                        if (loggedInUser) {
                            const likerEntry = likedByDetailsMap[loggedInUser.uid];
                            if (likerEntry && likerEntry.lastLikedAt) {
                                const lastLikedDate = likerEntry.lastLikedAt.toDate();
                                if ((new Date().getTime() - lastLikedDate.getTime()) < (24 * 60 * 60 * 1000)) { likeBtnTextOnOthers.textContent = "Liked"; likeBtnOnOthers.disabled = true; }
                                else { likeBtnTextOnOthers.textContent = "Like"; likeBtnOnOthers.disabled = false; }
                            } else { likeBtnTextOnOthers.textContent = "Like"; likeBtnOnOthers.disabled = false; }
                        } else { likeBtnOnOthers.disabled = true; }
                        likeBtnOnOthers.onclick = async () => {
                            if (!loggedInUser) { showToast("Please login to like profiles.", "error"); return; }
                            likeBtnOnOthers.disabled = true; const result = await likeProfile(userIdToLoad);
                            if(result.success) {
                               const updatedDoc = await db.collection('users').doc(userIdToLoad).get();
                               if(updatedDoc.exists) {
                                    const updatedData = updatedDoc.data(); const newLikesMap = updatedData.likedByDetails || {};
                                    document.getElementById('profile-likes-count-on-others-page').querySelector('span:last-child').textContent = `${Object.keys(newLikesMap).length} Likes`;
                                    likeBtnTextOnOthers.textContent = "Liked";
                               }
                            } else { if(!result.message.includes("You can like again in")) likeBtnOnOthers.disabled = false; }
                        };
                    }
                } else { showToast("Profile not found.", "error"); }
            } catch (error) { console.error("Error in loadProfilePageAndUpdateUI:", error); showToast("Could not load profile.", "error"); }
        }
        function openBioEditor(currentBio) {
            const bioModal = document.getElementById('edit-bio-modal');
            const bioInput = document.getElementById('bio-input');
            if (bioModal && bioInput) {
                bioInput.value = currentBio || '';
                bioModal.classList.remove('hidden');
            }
        }
        function handleAuthForms() {
            const registerForm = document.getElementById("register-form");
            const loginForm = document.getElementById("login-form");
            const authMessageDiv = document.getElementById("auth-message");
            const forgotPasswordLink = document.getElementById("forgot-password-link");
            const showLoginLink = document.getElementById("show-login-link");
            const showRegisterLink = document.getElementById("show-register-link");
            const showAuthMessageInBox = (message, type) => {
                if(authMessageDiv) { authMessageDiv.textContent = message; authMessageDiv.className = `auth-message message-${type}`; }
                else { console.warn("Auth message div not found."); }
            };
            if (forgotPasswordLink) {
                forgotPasswordLink.addEventListener("click", (e) => {
                    e.preventDefault();
                    const email = prompt("Please enter your email address to reset your password:"); 
                    if (email) {
                        auth.sendPasswordResetEmail(email)
                            .then(() => { showAuthMessageInBox("Password reset email sent! Check your inbox.", "success"); })
                            .catch((error) => { console.error("Forgot password error:", error); showAuthMessageInBox(error.message, "error"); });
                    }
                });
            } else { console.warn("Forgot password link not found");}
            if (registerForm) {
                registerForm.addEventListener("submit", async (e) => {
                    e.preventDefault();
                    const registerContainer = document.getElementById('register-container');
                    if (!registerContainer || registerContainer.classList.contains('hidden')) {
                        console.warn("Register form submitted while its container was hidden. Preventing action.");
                        if(authMessageDiv) { authMessageDiv.className = 'auth-message'; authMessageDiv.textContent = '';}
                        return;
                    }
                    const email = document.getElementById("register-email").value;
                    const password = document.getElementById("register-password").value;
                    let referralCodeInput = document.getElementById("referral-code-input").value.trim();
                    const newUserOwnFFIgn = document.getElementById("register-ff-ign").value.trim();
                    let referredById = null;
                    let newAccountBonus = 0;
                    let canAttemptReferrerBonus = false;
                    let referrerIgnForNotification = 'A player';
                    if (referralCodeInput) {
                        const deviceId = getDeviceId();
                        const deviceQuery = await db.collection('users').where('registeredFromDeviceId', '==', deviceId).limit(1).get();
                        if (deviceQuery.empty) {
                            const referrerQuery = await db.collection('users').where('referralCode', '==', referralCodeInput).get();
                            if (!referrerQuery.empty) {
                                referredById = referrerQuery.docs[0].id;
                                referrerIgnForNotification = sanitizeIgnForDisplay(referrerQuery.docs[0].data().ign || 'A player');
                                newAccountBonus = REFERRAL_BONUS_AMOUNT;
                                canAttemptReferrerBonus = true;
                                console.log("Referral code valid. Referrer ID:", referredById, "New account bonus:", newAccountBonus);
                            } else {
                                showAuthMessageInBox("Invalid referral code. Registration will proceed without referral benefits.", "warning");
                                referralCodeInput = "";
                            }
                        } else {
                            showToast("Referral bonus cannot be claimed from a previously used device. Registration proceeding without referral benefits.", "warning");
                            referralCodeInput = "";
                        }
                    }
                    let cred;
                    try {
                        console.log("Attempting to create auth user...");
                        cred = await auth.createUserWithEmailAndPassword(email, password);
                        console.log("Auth user created successfully, UID:", cred.user.uid);
                        if (referredById && cred.user && referredById === cred.user.uid) {
                            console.warn("Self-referral attempt detected, nullifying referral benefits.");
                            referredById = null;
                            newAccountBonus = 0;
                            canAttemptReferrerBonus = false;
                        }
                        const newReferralCode = Math.random().toString(36).substring(2, 8).toUpperCase();
                        const newUserDoc = {
                            email: email,
                            depositWallet: newAccountBonus,
                            winningsWallet: 0,
                            totalWinnings: 0,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                            referralCode: newReferralCode,
                            ign: newUserOwnFFIgn || email.split('@')[0],
                            bio: '',
                            profilePicUrl: DEFAULT_PROFILE_PIC_URL,
                            freefire_ign: newUserOwnFFIgn,
                            likedByDetails: {},
                            registeredFromDeviceId: getDeviceId(),
                            // New fields for new features
                            lastSpinTime: null,
                            lastLoginDate: null,
                            loginStreak: 0,
                            matchHistory: []
                        };
                        if (canAttemptReferrerBonus && referredById) {
                            newUserDoc.referredBy = referredById;
                        }
                        console.log("Attempting to set user document for UID:", cred.user.uid, "with data:", newUserDoc);
                        await db.collection("users").doc(cred.user.uid).set(newUserDoc);
                        console.log("User document set successfully for UID:", cred.user.uid);
                        let successToastMessage = "Registration successful! Welcome!";
                        if (newAccountBonus > 0) {
                            const newUserNotificationMessage = `Welcome! You received ${newAccountBonus} coins for joining via referral from ${referrerIgnForNotification}.`;
                            successToastMessage = newUserNotificationMessage;
                            db.collection('users').doc(cred.user.uid).collection('notifications').add({
                                message: newUserNotificationMessage,
                                read: false, timestamp: firebase.firestore.FieldValue.serverTimestamp(), type: 'success'
                            }).catch(err => console.error("Error adding new user referral notification:", err));
                        }
                        if (canAttemptReferrerBonus && referredById) {
                            console.log("Attempting to apply bonus to referrer:", referredById);
                            try {
                                await db.collection('users').doc(referredById).update({ winningsWallet: firebase.firestore.FieldValue.increment(REFERRAL_BONUS_AMOUNT) });
                                const referrerNotificationMessage = `You earned ${REFERRAL_BONUS_AMOUNT} winning coins! ${sanitizeIgnForDisplay(newUserOwnFFIgn || 'A new player')} joined using your referral code.`;
                                db.collection('users').doc(referredById).collection('notifications').add({
                                    message: referrerNotificationMessage,
                                    read: false, timestamp: firebase.firestore.FieldValue.serverTimestamp(), type: 'success'
                                }).catch(err => console.error("Error adding referrer bonus notification:", err));
                                console.log("Referrer bonus successfully applied to:", referredById);
                                if (newAccountBonus > 0) {
                                    successToastMessage += ` ${referrerIgnForNotification} also received a bonus!`;
                                } else {
                                     successToastMessage = `${referrerIgnForNotification} received ${REFERRAL_BONUS_AMOUNT} coins for your referral! Welcome!`;
                                }
                            } catch (referrerError) {
                                console.error("Failed to apply bonus to referrer:", referrerError);
                                showToast("New account created, but referrer bonus could not be applied. Admin may review.", "warning");
                            }
                        }
                        showToast(successToastMessage, "success");
                        if(authMessageDiv) { authMessageDiv.className = 'auth-message'; authMessageDiv.textContent = '';}
                    } catch (err) {
                        console.error("Critical registration error:", err);
                        showAuthMessageInBox(err.message || "Registration failed. Please try again.", "error");
                    }
                });
            } else { console.warn("Register form not found");}
            if (loginForm) {
                loginForm.addEventListener("submit", (e) => {
                    e.preventDefault();
                    const email = document.getElementById("login-email").value;
                    const password = document.getElementById("login-password").value;
                    auth.signInWithEmailAndPassword(email, password)
                        .then(userCredential => {
                            if(authMessageDiv) {
                                authMessageDiv.className = 'auth-message';
                                authMessageDiv.textContent = '';
                            }
                        })
                        .catch(err => {
                            console.error("Login error:", err);
                            let errorMessage = "Login failed. Please try again.";
                            if (err.code === 'auth/user-not-found' || err.code === 'auth/wrong-password' || err.code === 'auth/invalid-credential') {
                                errorMessage = "Invalid email or password.";
                            } else if (err.code === 'auth/invalid-email') {
                                errorMessage = "Invalid email format.";
                            } else if (err.code === 'auth/user-disabled') {
                                errorMessage = "Your account has been disabled.";
                            }
                            showToast(errorMessage, "error");
                        });
                });
            } else { console.warn("Login form not found");}
            if (showLoginLink) {
                showLoginLink.addEventListener("click", () => {
                    document.getElementById("register-container")?.classList.add("hidden");
                    const loginContainer = document.getElementById("login-container");
                    loginContainer?.classList.remove("hidden");
                    document.getElementById("login-email")?.focus();
                    if(authMessageDiv) {authMessageDiv.className = 'auth-message'; authMessageDiv.textContent = '';}
                });
            } else { console.warn("Show login link not found");}
            if (showRegisterLink) {
                showRegisterLink.addEventListener("click", () => {
                    document.getElementById("login-container")?.classList.add("hidden");
                    const registerContainer = document.getElementById("register-container");
                    registerContainer?.classList.remove("hidden");
                    document.getElementById("register-email")?.focus();
                    if(authMessageDiv) {authMessageDiv.className = 'auth-message'; authMessageDiv.textContent = '';}
                });
            } else { console.warn("Show register link not found");}
        }
        function setupWalletModal(user) {
            const walletTabs = document.querySelectorAll("#wallet-tabs a");
            const tabContents = document.querySelectorAll("#wallet-modal .modal-tab-content");
            walletTabs.forEach(tab => {
                tab.onclick = () => {
                    walletTabs.forEach(t => t.classList.remove("active"));
                    tab.classList.add("active");
                    tabContents.forEach(c => c.classList.toggle("hidden", c.id !== tab.dataset.tab));
                    if (tab.dataset.tab === "history" && user) { loadTransactionHistory(user.uid); }
                };
            });
            const addMoneyForm = document.getElementById("add-money-form");
            if (addMoneyForm && user) {
                addMoneyForm.onsubmit = async e => {
                    e.preventDefault();
                    const amountEl = document.getElementById("add-amount");
                    const utrEl = document.getElementById("utr-number");
                    if (!amountEl || !utrEl) { console.error("Add money form elements missing"); return;}
                    const amount = Number(amountEl.value);
                    const utr = utrEl.value.trim();
                    if (amount > 0 && utr) {
                        try {
                            await db.collection("transactions").add({ userId: user.uid, userEmail: user.email, type: "add", amount: amount, utr: utr, status: "pending", timestamp: firebase.firestore.FieldValue.serverTimestamp() });
                            showToast("Deposit request submitted!", "success"); addMoneyForm.reset();
                            document.getElementById("wallet-modal")?.classList.add("hidden");
                        } catch (error) { console.error("Error submitting deposit:", error); showToast("Failed to submit deposit.", "error");}
                    } else { showToast("Enter a valid amount and UTR.", "error"); }
                };
            }
            const withdrawMoneyForm = document.getElementById("withdraw-money-form");
            if (withdrawMoneyForm && user) withdrawMoneyForm.onsubmit = e => handleWithdrawal(e, user);
        }
        async function handleWithdrawal(e, user) {
            e.preventDefault();
            const form = document.getElementById("withdraw-money-form");
            const number = document.getElementById("withdraw-number").value.trim();
            const amount = Number(document.getElementById("withdraw-amount").value);
            if (!number || !/^\d{10,}$/.test(number)) { showToast("Enter a valid 10-digit PhonePe number.", "error"); return; }
            if (amount < 50) { showToast("Minimum withdrawal is 50 coins.", "error"); return; }
            const userRef = db.collection('users').doc(user.uid);
            try {
                await db.runTransaction(async (t) => {
                    const doc = await t.get(userRef); if (!doc.exists) throw new Error("User not found.");
                    const userData = doc.data(); const winningsBalance = userData.winningsWallet || 0;
                    if (amount > winningsBalance) { throw new Error("Insufficient winnings."); }
                    t.update(userRef, { winningsWallet: firebase.firestore.FieldValue.increment(-amount) });
                    t.set(db.collection("transactions").doc(), { userId: user.uid, userEmail: user.email, type: "withdraw", amount: amount, phonepeNumber: number, status: "pending", timestamp: firebase.firestore.FieldValue.serverTimestamp() });
                });
                showToast("Withdrawal request submitted! Coins deducted.", "success");
                if (form) form.reset(); document.getElementById("wallet-modal")?.classList.add("hidden");
            } catch (error) { console.error("Withdrawal error:", error); showToast(`Error: ${error.message}`, "error"); }
        }
        async function uploadProfilePicture(event, user) {
            const file = event.target.files[0]; if (!file) return;
            if (!file.type.startsWith('image/')) { showToast("Please select an image file.", "error"); return; }
            if (file.size > 2 * 1024 * 1024) { showToast("Image size < 2MB.", "error"); return; }
            if (!IMGBB_API_KEY || IMGBB_API_KEY === "YOUR_IMGBB_API_KEY") { showToast("Image upload not configured. Please contact admin.", "error"); return; }
            showToast("Uploading picture...", "success");
            const formData = new FormData(); formData.append('image', file);
            try {
                const response = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, { method: 'POST', body: formData });
                const result = await response.json();
                if (result.success && result.data.url) {
                    await db.collection('users').doc(user.uid).update({ profilePicUrl: result.data.url });
                    showToast("Profile picture updated!", "success");
                } else { throw new Error(result.error?.message || 'ImgBB API error.'); }
            } catch (error) { console.error("Upload Error: ", error); showToast(`Upload failed: ${error.message}`, "error"); }
        }
        async function saveProfileDetails(user) {
            const freefire_ign = document.getElementById('freefire-ign-input').value.trim();
            const sanitizedFFIgn = sanitizeIgnForDisplay(freefire_ign); 
            try {
                await db.collection('users').doc(user.uid).update({
                    freefire_ign: sanitizedFFIgn,
                    ign: sanitizedFFIgn || (user.email ? user.email.split('@')[0] : "User")
                });
                showToast("Game info saved!", "success");
            } catch (error) { console.error("Error saving profile details:", error); showToast("Failed to save info.", "error"); }
        }
        function copyReferralCode() {
            const codeEl = document.getElementById('referral-code'); if(!codeEl) return;
            const code = codeEl.textContent;
            if (navigator.clipboard && navigator.clipboard.writeText) { navigator.clipboard.writeText(code).then(() => showToast('Referral code copied!', 'success')).catch(() => fallbackCopyTextToClipboard(code));}
            else { fallbackCopyTextToClipboard(code); }
        }
        function fallbackCopyTextToClipboard(text) {
            const ta = document.createElement("textarea"); ta.value = text; ta.style.position="fixed"; document.body.appendChild(ta); ta.focus(); ta.select();
            try { if(document.execCommand('copy')) showToast('Referral code copied!', 'success'); else showToast('Failed to copy.', 'error');}
            catch (err) { showToast('Failed to copy.', 'error');} document.body.removeChild(ta);
        }
        async function joinMatch(matchId, joinFee, gameTypeFromCard) {
            const joinBtn = document.querySelector(`.tournament-card[data-match-id="${matchId}"] .join-btn`);
            if (joinBtn) { joinBtn.disabled = true; joinBtn.innerHTML = 'JOINING...';}
            const userId = auth.currentUser.uid; const userRef = db.collection('users').doc(userId); const matchRef = db.collection("tournaments").doc(matchId);
            let bgmiIgn = null;
            if (gameTypeFromCard === 'BGMI') {
                bgmiIgn = prompt("Please enter your BGMI In-Game Name (IGN):");
                if (!bgmiIgn || bgmiIgn.trim() === "") {
                    showToast("BGMI IGN is required to join.", "error");
                    if (joinBtn) { joinBtn.disabled = false; joinBtn.innerHTML = 'JOIN'; }
                    return;
                }
            }
            try {
                await db.runTransaction(async (t) => {
                    const userDoc = await t.get(userRef); const matchDoc = await t.get(matchRef);
                    if (!userDoc.exists) throw new Error("User data not found."); if (!matchDoc.exists) throw new Error("Match removed!");
                    const userData = userDoc.data(); const matchData = matchDoc.data(); const actualGameType = matchData.gameType || gameTypeFromCard;
                    if (!actualGameType) throw new Error("Game type undefined.");
                    let userSpecificIgn;
                    if (actualGameType === "BGMI") { userSpecificIgn = bgmiIgn; }
                    else if (actualGameType === "FREEFIRE") { userSpecificIgn = userData.freefire_ign; }
                    else { throw new Error(`Unknown game type: ${actualGameType}`); }
                    if (!userSpecificIgn) throw new Error(`Update your ${actualGameType} IGN in your profile.`);
                    if (matchData.participants && matchData.participants.includes(userId)) throw new Error("Already joined.");
                    if ((matchData.playersJoined || 0) >= matchData.maxPlayers) throw new Error("Match full.");
                    if (matchData.status !== "upcoming") throw new Error("Match not available.");
                    let deposit = userData.depositWallet || 0; let winnings = userData.winningsWallet || 0;
                    if ((deposit + winnings) < joinFee) throw new Error("Insufficient coins.");
                    let feeFromDeposit = Math.min(deposit, joinFee); let feeFromWinnings = joinFee - feeFromDeposit;
                    t.update(userRef, { depositWallet: firebase.firestore.FieldValue.increment(-feeFromDeposit), winningsWallet: firebase.firestore.FieldValue.increment(-feeFromWinnings) });
                    t.update(matchRef, { playersJoined: firebase.firestore.FieldValue.increment(1), participants: firebase.firestore.FieldValue.arrayUnion(userId) });
                    t.set(db.collection("transactions").doc(), { userId: userId, userEmail: userData.email, type: "join_fee", amount: joinFee, matchId: matchId, matchTitle: matchData.title, gameType: actualGameType, status: "completed", timestamp: firebase.firestore.FieldValue.serverTimestamp() });
                });
                showToast("Joined match!", "success");
            } catch (error) { console.error("Join match error:", error); showToast(`Could not join: ${error.message}`, "error"); }
            finally {  if (joinBtn) { joinBtn.disabled = false; joinBtn.innerHTML = `JOIN`; } }
        }
        function loadTransactionHistory(userId) {
            if (transactionHistoryListener) { transactionHistoryListener(); transactionHistoryListener = null; }
            const container = document.querySelector("#wallet-modal .transaction-history-list");
            if (!container) return;
            container.innerHTML = `<p style="text-align:center; padding:10px;">Loading...</p>`;
            transactionHistoryListener = db.collection("transactions").where("userId", "==", userId).orderBy("timestamp", "desc").limit(30)
                .onSnapshot(snapshot => {
                    if (!container) return;
                    container.innerHTML = ""; if (snapshot.empty) { container.innerHTML = `<p style="text-align:center; padding:10px;">No transactions.</p>`; return; }
                    snapshot.forEach(doc => {
                        const data = doc.data(); let displayStatusText = "Unknown"; let statusClass = "unknown";
                        if (data.status && typeof data.status === 'string') {
                            const normalizedStatus = data.status.trim().toLowerCase(); displayStatusText = data.status;
                            if (normalizedStatus === "pending") statusClass = "pending";
                            else if (normalizedStatus === "completed" || normalizedStatus === "complete") statusClass = "completed";
                            else if (normalizedStatus === "rejected" || normalizedStatus === "failed") statusClass = "rejected";
                            else statusClass = normalizedStatus;
                        }
                        let iconClass = '', iconName = '', prefix = data.type ? data.type.replace(/_/g, ' ') : 'Transaction'; prefix = prefix.charAt(0).toUpperCase() + prefix.slice(1);
                        if (data.type === 'add') { iconClass = 'add'; iconName = 'arrow_upward'; prefix = 'Added'; }
                        else if (data.type === 'withdraw') { iconClass = 'withdraw'; iconName = 'arrow_downward'; prefix = 'Withdrew'; }
                        else if (data.type === 'win') { iconClass = 'add'; iconName = 'emoji_events'; prefix = 'Won'; }
                        else if (data.type === 'join_fee') { iconClass = 'withdraw'; iconName = 'exit_to_app'; prefix = `Joined ${data.gameType || ''} Match`; }
                        else if (data.type === 'custom_match_fee') { iconClass = 'withdraw'; iconName = 'gamepad'; prefix = `Challenge Fee (${data.gameType || ''} ${data.matchType || ''})`; }
                        else if (data.type === 'custom_match_win') { iconClass = 'add'; iconName = 'emoji_events'; prefix = `Challenge Won (${data.gameType || ''} ${data.matchType || ''})`; }
                        else { iconName = 'help_outline'; }
                        container.innerHTML += `<div class="transaction-item"><span class="material-icons icon ${iconClass}">${iconName}</span><div class="details"><div class="amount">${sanitizeForHTML(prefix)} ${data.amount || 0} Coins ${data.matchTitle ? `(${sanitizeForHTML(data.matchTitle)})` : (data.matchId ? `(#${sanitizeForHTML(data.matchId.slice(-4))})` : '')}</div><div class="time">${timeAgo(data.timestamp)}</div>${data.utr ? `<div class="time" style="font-size:0.7rem; word-break:break-all;">UTR: ${sanitizeForHTML(data.utr)}</div>` : ''}</div><div class="status ${statusClass}">${sanitizeForHTML(displayStatusText)}</div></div>`;
                    });
                }, err => { console.error("Error loading transaction history:", err); if(container) container.innerHTML = '<p style="text-align:center; padding:10px;">Could not load history.</p>'; });
        }
        function loadMatchesByGameAndStatus(userId, gameType, status) {
            if (matchesListener) { matchesListener(); matchesListener = null; }
            const container = document.querySelector("#matches-page .tournament-list"); if (!container) return;
            renderSkeletonCard(container, 4);
            matchesListener = db.collection("tournaments").where("gameType", "==", gameType).where("status", "==", status).orderBy("matchId", "desc")
                .onSnapshot(snapshot => {
                    if (!container) return;
                    container.innerHTML = ""; if (snapshot.empty) { container.innerHTML = `<p style="text-align:center; padding:10px;">No ${gameType} ${status} matches.</p>`; }
                    else { snapshot.forEach(doc => renderTournamentCard(container, doc.id, doc.data(), userId)); }
                }, err => { console.error(`Error loading matches:`, err); if(container) container.innerHTML = `<p style="text-align:center; padding:10px;">Could not load matches.</p>`;});
        }
        function loadHistoryMatches(userId) {
            if (historyMatchesListener) { historyMatchesListener(); historyMatchesListener = null; }
            const container = document.querySelector(".history-list"); if(!container) return;
            renderSkeletonCard(container, 5);
            historyMatchesListener = db.collection("tournaments").where("participants", "array-contains", userId).orderBy("matchId", "desc")
                .onSnapshot(snapshot => {
                    if (!container) return;
                    container.innerHTML = "";
                    if (snapshot.empty) { container.innerHTML = "<p style='text-align:center; padding:10px;'>No matches in history.</p>"; }
                    else { snapshot.forEach(doc => renderTournamentCard(container, doc.id, doc.data(), userId)); }
                }, err => { console.error("Error loading history:", err); if(container) container.innerHTML = "<p style='text-align:center; padding:10px;'>Could not load history.</p>";});
        }
        
        function renderTournamentCard(container, docId, tourney, userId) {
            const progress = (tourney.playersJoined || 0) / (tourney.maxPlayers || 1) * 100;
            const isJoined = tourney.participants && tourney.participants.includes(userId);
            let joinButtonHTML = "";
            const gameTypeForJoin = tourney.gameType || '';

            if (tourney.status === "upcoming") {
                joinButtonHTML = isJoined
                    ? `<button class="join-btn" disabled>JOINED</button>`
                    : ((tourney.playersJoined || 0) >= tourney.maxPlayers)
                        ? `<button class="join-btn" disabled>FULL</button>`
                        : `<button class="join-btn" onclick="joinMatch('${docId}',${tourney.joinFee || 0}, '${gameTypeForJoin}')">JOIN</button>`;
            } else if (tourney.status === "ongoing") {
                joinButtonHTML = isJoined
                    ? `<button class="join-btn" style="background-color: var(--coin-gold); color:black;" disabled>PLAYING</button>`
                    : `<button class="join-btn" disabled>ONGOING</button>`;
            } else {
                joinButtonHTML = `<button class="join-btn" disabled>${sanitizeForHTML((tourney.status || "N/A").toUpperCase())}</button>`;
            }

            const playersJoinedInfo = `<div class="progress-bar-info" onclick="showJoinedPlayers('${docId}')" role="button" tabindex="0">${tourney.playersJoined||0}/${tourney.maxPlayers||0} Players (View)</div>`;
            
            let roomCredentialsHTML = '';
            if (isJoined && (tourney.status === 'ongoing' || (tourney.status === 'upcoming' && tourney.roomID)) && tourney.roomID) {
                roomCredentialsHTML = `<div class="room-credentials"><div>Room ID: <span>${sanitizeForHTML(tourney.roomID)}</span></div><div>Password: <span>${sanitizeForHTML(tourney.roomPassword) || 'N/A'}</span></div></div>`;
            }
            
            let playerResultHTML = '';
            if (isJoined && tourney.status === 'results' && tourney.results && tourney.results[userId]) {
                const myResult = tourney.results[userId];
                playerResultHTML = `<div class="player-result-info">Kills: <span>${myResult.kills || 0}</span> | Winnings: <span>${(myResult.winnings || 0).toFixed(2)}</span></div>`;
            }

            let tagsHTML = '';
            if (tourney.tags && Array.isArray(tourney.tags) && tourney.tags.length > 0) {
                tagsHTML = tourney.tags.slice(0, 3).map(tag => `<span>${sanitizeForHTML(tag.text) || 'N/A'}</span>`).join('');
            } else {
                tagsHTML = `<span>${sanitizeForHTML(tourney.gameType) || 'N/A'}</span>`;
            }

            let countdownHTML = '';
            const countdownTimerId = `timer-${docId}`;
            if (tourney.status === 'upcoming' && tourney.dateTime) {
                let targetTime = tourney.dateTime.toDate ? tourney.dateTime.toDate().getTime() : new Date(tourney.dateTime).getTime();
                if (!isNaN(targetTime) && targetTime > Date.now()) {
                    countdownHTML = `<div id="${countdownTimerId}" class="countdown-timer">Loading timer...</div>`;
                } else if (!isNaN(targetTime)) {
                    countdownHTML = `<div class="countdown-timer" style="color:var(--accent-red);">Match time passed!</div>`;
                }
            }

            const prizeHTML = tourney.prize != null ? `<div class="detail-item"><div class="label">PRIZE</div><div class="value"><span class="material-icons">monetization_on</span>${(tourney.prize).toFixed(2)}</div></div>` : '';
            const perKillHTML = tourney.perKill != null ? `<div class="detail-item"><div class="label">PERKILL</div><div class="value"><span class="material-icons">monetization_on</span>${(tourney.perKill).toFixed(2)}</div></div>` : '';

            const cardDetailsGridHTML = `
                <div class="card-details-grid">
                    <div class="detail-item"><div class="label">TIME</div><div class="value">${sanitizeForHTML(tourney.time) || 'TBA'}</div></div>
                    ${prizeHTML}
                    ${perKillHTML}
                    <div class="detail-item"><div class="label">JOIN FEE</div><div class="value"><span class="material-icons">monetization_on</span>${(tourney.joinFee || 0).toFixed(2)}</div></div>
                </div>
            `;

            const cardElement = document.createElement('div');
            cardElement.className = 'tournament-card';
            cardElement.dataset.gametype = gameTypeForJoin;
            cardElement.dataset.matchId = docId;

            cardElement.innerHTML = `
                <div class="card-top-row">${tagsHTML}</div>
                <h3 class="card-title">${sanitizeForHTML(tourney.title) || 'Untitled'} - #${sanitizeForHTML(tourney.matchId) || 'N/A'}</h3>
                ${countdownHTML}
                ${roomCredentialsHTML}
                ${cardDetailsGridHTML}
                ${playerResultHTML}
                <div class="card-footer">
                    <div class="progress-bar-container">
                        ${playersJoinedInfo}
                        <div class="progress-bar"><div class="progress-bar-fill" style="width:${progress}%;"></div></div>
                    </div>
                    ${joinButtonHTML}
                </div>
            `;
            container.appendChild(cardElement);

            if (tourney.status === 'upcoming' && tourney.dateTime && document.getElementById(countdownTimerId)) {
                let targetTime = tourney.dateTime.toDate ? tourney.dateTime.toDate().getTime() : new Date(tourney.dateTime).getTime();
                if (!isNaN(targetTime) && targetTime > Date.now()) {
                    startCountdownTimer(countdownTimerId, targetTime);
                }
            }
        }
        
        async function showJoinedPlayers(matchId) {
            const modal = document.getElementById('joined-players-modal'); const listEl = document.getElementById('joined-players-list'); if(!modal || !listEl) return;
            listEl.innerHTML = '<p style="text-align:center; padding:10px;">Loading players...</p>'; modal.classList.remove('hidden');
            try {
                const matchDoc = await db.collection('tournaments').doc(matchId).get(); if (!matchDoc.exists) { listEl.innerHTML = '<p>Match not found.</p>'; return; }
                const participantIds = matchDoc.data().participants || []; if (participantIds.length === 0) { listEl.innerHTML = '<p>No players joined.</p>'; return; }
                listEl.innerHTML = '';
                const userPromises = participantIds.map(userId => db.collection('users').doc(userId).get()); const userDocs = await Promise.all(userPromises);
                userDocs.forEach(userDoc => { if (userDoc.exists) { const userData = userDoc.data();
                    const playerEl = document.createElement('div');
                    playerEl.style = 'display:flex; align-items:center; gap:10px; padding:8px; border-bottom:1px solid var(--secondary-bg); cursor:pointer;';
                    playerEl.onclick = () => { modal.classList.add('hidden'); openUserInspectModal(userDoc.id); };
                    const sanitizedIgn = sanitizeIgnForDisplay(userData.ign || "Player");
                    const sanitizedBio = sanitizeIgnForDisplay(userData.bio || "No bio");
                    playerEl.innerHTML = `<img src="${userData.profilePicUrl || DEFAULT_PROFILE_PIC_URL}" alt="pfp" style="width:40px;height:40px;border-radius:50%;object-fit:cover;"><div><span style="font-weight:500;">${sanitizedIgn}</span><small style="display:block;color:var(--text-tertiary);">${sanitizedBio}</small></div>`;
                    listEl.appendChild(playerEl);
                }});
                if(listEl.innerHTML === '') { listEl.innerHTML = '<p>Could not load player details.</p>';}
            } catch (error) { console.error("Error showing joined players:", error); listEl.innerHTML = '<p>Error loading players.</p>';}
        }
        function loadChatMessages(user) {
            if (chatListener) { chatListener(); chatListener = null; }
            const container = document.getElementById("chat-page")?.querySelector(".chat-messages");
            const chatForm = document.getElementById("chat-form");
            if (!container || !chatForm) { console.error("Global chat elements not found!"); return; }
            chatListener = db.collection("chatMessages").orderBy("timestamp", "asc").limitToLast(50)
                .onSnapshot(snapshot => {
                    if (!container) return;
                    container.innerHTML = "";
                    snapshot.forEach(doc => {
                        const data = doc.data(); const isSent = data.senderId === user.uid;
                        const messageRow = document.createElement("div"); messageRow.className = `message-row ${isSent ? "sent" : "received"}`;
                        const chatMessageDiv = document.createElement("div"); chatMessageDiv.className = `chat-message ${isSent ? "sent" : "received"}`;
                        if (!isSent) {
                            const senderDiv = document.createElement("div"); senderDiv.className = "sender";
                            senderDiv.textContent = sanitizeIgnForDisplay(data.senderName || (data.senderEmail ? data.senderEmail.split("@")[0] : "User"));
                            senderDiv.onclick = () => openUserInspectModal(data.senderId);
                            chatMessageDiv.appendChild(senderDiv);
                        }
                        const textDiv = document.createElement("div"); textDiv.className = "text"; textDiv.textContent = data.text;
                        chatMessageDiv.appendChild(textDiv); messageRow.appendChild(chatMessageDiv); container.appendChild(messageRow);
                    });
                    if(container.children.length > 0) { container.scrollTop = container.scrollHeight; }
                }, err => { console.error("Error loading global chat:", err); container.innerHTML = "<p>Could not load chat.</p>";});
            chatForm.onsubmit = async e => {
                e.preventDefault();
                const chatInput = document.getElementById("chat-input"); const text = chatInput.value.trim();
                if (text && user) {
                    try {
                        const userDoc = await db.collection('users').doc(user.uid).get();
                        let senderName = user.email ? user.email.split('@')[0] : "Anonymous";
                        if (userDoc.exists) { const uData = userDoc.data(); senderName = uData.ign || "User"; }
                        await db.collection("chatMessages").add({ text: text, senderId: user.uid, senderEmail: user.email || "", senderName: senderName, timestamp: firebase.firestore.FieldValue.serverTimestamp() });
                        chatInput.value = "";
                    } catch (error) { console.error("Error sending chat message:", error); showToast("Could not send message.", "error"); }
                }
            };
        }
        function setupCustomMatchPageListeners() {
            document.getElementById('create-custom-match-form')?.addEventListener('submit', handleCreateCustomMatch);
            document.getElementById('cm-entry-fee')?.addEventListener('change', updateCreateChallengePrizeDisplay);
            document.getElementById('cm-match-type')?.addEventListener('change', updateCreateChallengePrizeDisplay);
            updateCreateChallengePrizeDisplay();
            document.getElementById('custom-match-main-tabs')?.addEventListener('click', e => { if (e.target.tagName === 'A' && e.target.dataset.subpage) handleCustomMatchMainTabSwitch(e.target.dataset.subpage);});
            document.getElementById('filter-cm-game-type')?.addEventListener('change', loadAvailableCustomMatches);
            document.getElementById('filter-cm-match-type')?.addEventListener('change', loadAvailableCustomMatches);
            document.getElementById('filter-cm-entry-fee')?.addEventListener('change', loadAvailableCustomMatches);
            const gameTypeSelect = document.getElementById('cm-game-type');
            if (gameTypeSelect) {
                gameTypeSelect.addEventListener('change', function() {
                    const ffSettings = document.getElementById('freefire-settings-container');
                    const bgmiSettings = document.getElementById('bgmi-settings-container');
                    const roomSettingsHeader = document.querySelector('#create-custom-match-form h4[style*="Room Settings"]');
                    const noSettingsPara = document.querySelector('#create-custom-match-form p[style*="No specific in-game settings"]');
                    if (ffSettings) ffSettings.classList.add('hidden');
                    if (bgmiSettings) bgmiSettings.classList.add('hidden');
                    if (this.value === 'BGMI') {
                        if (roomSettingsHeader) roomSettingsHeader.style.display = 'none';
                        if (noSettingsPara) noSettingsPara.style.display = 'block';
                    } else {
                        if (roomSettingsHeader) roomSettingsHeader.style.display = 'none';
                        if (noSettingsPara) noSettingsPara.style.display = 'block';
                    }
                });
                gameTypeSelect.dispatchEvent(new Event('change'));
            }
        }
        function handleCustomMatchMainTabSwitch(subpageId) {
            document.querySelectorAll('#custom-match-main-tabs a').forEach(t => t.classList.remove('active'));
            document.querySelector(`#custom-match-main-tabs a[data-subpage="${subpageId}"]`)?.classList.add('active');
            document.querySelectorAll('.custom-match-subpage').forEach(sp => sp.style.display = 'none');
            const pageToShow = document.getElementById(subpageId);
            if (pageToShow) pageToShow.style.display = 'flex';
            if (customMatchesListener) { customMatchesListener(); customMatchesListener = null; }
            if (myCustomMatchesListener) { myCustomMatchesListener(); myCustomMatchesListener = null; }
            if (subpageId === 'join-custom-match') loadAvailableCustomMatches();
            else if (subpageId === 'my-custom-matches') loadMyCustomMatches();
            else if (subpageId === 'create-custom-match') updateCreateChallengePrizeDisplay();
        }
        function updateCreateChallengePrizeDisplay() {
            const entryFeeEl = document.getElementById('cm-entry-fee'); const matchTypeEl = document.getElementById('cm-match-type'); const prizeDisplayEl = document.getElementById('cm-prize-pool-display');
            if (!entryFeeEl || !matchTypeEl || !prizeDisplayEl) return;
            const entryFee = parseInt(entryFeeEl.value); const matchType = matchTypeEl.value;
            let numPlayers = (matchType === '2v2' ? 4 : 2); let calculatedPrizePool = (entryFee * numPlayers) - 2;
            if (calculatedPrizePool < 0) calculatedPrizePool = 0; prizeDisplayEl.textContent = calculatedPrizePool;
        }
        async function handleCreateCustomMatch(event) {
            event.preventDefault(); const user = auth.currentUser; if (!user) { showToast("Login to create challenge.", "error"); return; }
            const gameType = document.getElementById('cm-game-type').value;
            const matchType = document.getElementById('cm-match-type').value;
            const entryFee = parseInt(document.getElementById('cm-entry-fee').value);
            const privacy = document.getElementById('cm-privacy').value;
            let roomSettings = {};
            let numPlayersRequired = (matchType === '2v2' ? 4 : 2);
            let prizePool = (entryFee * numPlayersRequired) - 2;
            if (prizePool < 0) prizePool = 0;
            const userDocSnap = await db.collection('users').doc(user.uid).get();
            if (!userDocSnap.exists) { showToast("User data not found.", "error"); return; }
            const userData = userDocSnap.data();
            if ((userData.depositWallet || 0) + (userData.winningsWallet || 0) < entryFee) { showToast("Insufficient balance.", "error"); return; }
            const userRef = db.collection('users').doc(user.uid);
            const creatorDisplayName = userData.ign || user.email.split('@')[0];
            const matchId = "CM_" + Date.now().toString().slice(-6) + Math.random().toString(36).substring(2, 4).toUpperCase();
            const customMatchData = {
                matchId,
                createdBy: user.uid,
                creatorIgn: creatorDisplayName,
                gameType,
                matchType,
                entryFee,
                prizePool,
                privacy,
                status: "open",
                players: [{ uid: user.uid, ign: creatorDisplayName, team: (matchType === '2v2' ? 1: null) }],
                playersArray: [user.uid],
                teams: matchType === '2v2' ? { team1: [user.uid], team2: [] } : null,
                numPlayersRequired,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                reports: {},
                settings: roomSettings,
                roomDetails: { id: null, pass: null }
            };
            try {
                await db.runTransaction(async (t) => {
                    const userDoc = await t.get(userRef); if (!userDoc.exists) throw "User document does not exist!";
                    const currentData = userDoc.data(); let feeFromDeposit = Math.min(currentData.depositWallet || 0, entryFee); let feeFromWinnings = entryFee - feeFromDeposit;
                    if ((currentData.depositWallet || 0) + (currentData.winningsWallet || 0) < entryFee) throw "Insufficient balance.";
                    t.update(userRef, { depositWallet: firebase.firestore.FieldValue.increment(-feeFromDeposit), winningsWallet: firebase.firestore.FieldValue.increment(-feeFromWinnings) });
                    t.set(db.collection(CUSTOM_MATCHES_COLLECTION).doc(matchId), customMatchData);
                    t.set(db.collection("transactions").doc(), { userId: user.uid, userEmail: user.email, type: "custom_match_fee", amount: entryFee, matchId: customMatchData.matchId, gameType: customMatchData.gameType, matchType: customMatchData.matchType, status: "completed", timestamp: firebase.firestore.FieldValue.serverTimestamp() });
                });
                showToast("Challenge created! Fee deducted.", "success");
                document.getElementById('create-custom-match-form').reset();
                updateCreateChallengePrizeDisplay();
                handleCustomMatchMainTabSwitch('my-custom-matches');
            } catch (error) {
                console.error("Error creating custom match:", error);
                showToast("Failed to create: " + (error.message || error), "error");
            }
        }
        function loadAvailableCustomMatches() {
            if (customMatchesListener) { customMatchesListener(); customMatchesListener = null; }
            const container = document.getElementById('available-custom-matches-list'); if (!container) return;
            renderSkeletonCard(container, 3);
            let query = db.collection(CUSTOM_MATCHES_COLLECTION).where('status', '==', 'open').where('privacy', '==', 'public').orderBy('createdAt', 'desc');
            const gameFilter = document.getElementById('filter-cm-game-type').value; const typeFilter = document.getElementById('filter-cm-match-type').value; const feeFilter = document.getElementById('filter-cm-entry-fee').value;
            if (gameFilter) query = query.where('gameType', '==', gameFilter); if (typeFilter) query = query.where('matchType', '==', typeFilter); if (feeFilter) query = query.where('entryFee', '==', parseInt(feeFilter));
            query = query.limit(30);
            customMatchesListener = query.onSnapshot(snapshot => {
                if (!container) return;
                container.innerHTML = ""; if (snapshot.empty) { container.innerHTML = `<p style="text-align:center; padding:10px;">No open challenges found.</p>`; return; }
                snapshot.forEach(doc => renderCustomMatchCard(container, doc.id, doc.data(), 'join'));
            }, err => { console.error("Error loading custom matches:", err); if(container) container.innerHTML = `<p>Error loading challenges.</p>`;});
        }
        function loadMyCustomMatches() {
            if (myCustomMatchesListener) { myCustomMatchesListener(); myCustomMatchesListener = null; }
            const container = document.getElementById('my-challenges-list'); const user = auth.currentUser; if (!container || !user) return;
            renderSkeletonCard(container, 2);
            myCustomMatchesListener = db.collection(CUSTOM_MATCHES_COLLECTION).where('playersArray', 'array-contains', user.uid).orderBy('createdAt', 'desc').limit(30)
                .onSnapshot(snapshot => {
                    if(!container) return;
                    container.innerHTML = ""; if (snapshot.empty) { container.innerHTML = `<p style="text-align:center; padding:10px;">No challenges joined or created.</p>`; return; }
                    snapshot.forEach(doc => renderCustomMatchCard(container, doc.id, doc.data(), 'view'));
                }, err => { console.error("Error loading my custom matches:", err); if(container) container.innerHTML = `<p>Error loading your challenges.</p>`;});
        }
        
        function renderCustomMatchCard(container, docId, match, type = 'join') {
            const user = auth.currentUser;
            const card = document.createElement('div');
            card.className = 'custom-match-card';
            card.dataset.gametype = match.gameType || 'FREEFIRE';

            const playersJoined = match.players ? match.players.length : 0;
            const isParticipant = user && match.playersArray && match.playersArray.includes(user.uid);
            const canJoin = !isParticipant && match.status === 'open' && playersJoined < match.numPlayersRequired;
            const playersListHTML = (match.players || []).map(p => `<span class="player-pill">${sanitizeForHTML(sanitizeIgnForDisplay(p.ign))}</span>`).join('') || '<span class="player-pill" style="opacity:0.6;">None</span>';
            const settingsBlockHTML = `
                <div class="card-settings-block">
                    <div class="setting-row">
                        <div class="setting-col full">
                            <span class="label">Players:</span>
                            <div class="player-pill-list">${playersListHTML}</div>
                        </div>
                    </div>
                </div>
            `;
            let roomDetailsHTML = '';
            if (isParticipant && match.roomDetails && match.roomDetails.id) {
                 roomDetailsHTML = `<div class="room-credentials" style="margin-top:10px;"><div>Room ID: <span>${sanitizeForHTML(match.roomDetails.id)}</span></div><div>Password: <span>${sanitizeForHTML(match.roomDetails.pass) || 'N/A'}</span></div></div>`;
            }
            let actionButtonHTML = '';
            if (type === 'join' && canJoin) {
                actionButtonHTML = `<button class="join-btn" onclick="joinCustomMatch(event, '${docId}')">Join (${match.entryFee} Coins)</button>`;
            } else if (isParticipant && match.status === 'open') {
                actionButtonHTML = `<button class="join-btn" disabled>Waiting</button>`;
            } else if (match.status === 'completed' || match.status === 'cancelled') {
                 actionButtonHTML = `<button class="join-btn" disabled style="background-color: ${match.status === 'cancelled' ? 'var(--accent-red)' : 'var(--text-tertiary)'};">${sanitizeForHTML(match.status.toUpperCase())}</button>`;
            } else if (isParticipant && (match.status === 'full' || match.status === 'active' || match.status === 'pending_result')) {
                 actionButtonHTML = `<button class="join-btn" style="background-color: var(--coin-gold); color:black;" disabled>${match.status === 'full' ? 'FULL' : (match.status === 'active' ? 'PLAYING' : 'RESULT PENDING')}</button>`;
            } else {
                actionButtonHTML = `<button class="join-btn" disabled>${sanitizeForHTML((match.status || "N/A").toUpperCase())}</button>`;
            }
            let creatorActionsHTML = '';
            if (user && match.createdBy === user.uid && (match.status === 'full' || match.status === 'active')) {
                creatorActionsHTML = `
                    <button class="action-btn" style="width:100%; margin-top:10px; background-color: var(--button-secondary-bg); color: var(--button-secondary-text); border: 1px solid var(--tab-border-color);" onclick="openUpdateRoomModal('${docId}', '${sanitizeForHTML(match.roomDetails?.id || '')}', '${sanitizeForHTML(match.roomDetails?.pass || '')}')">Update Room</button>
                `;
            }
            let reportActionsHTML = '';
            if (isParticipant && ['full', 'active', 'pending_result'].includes(match.status)) {
                if (match.reports && match.reports[user.uid]) {
                    reportActionsHTML = `<button class="action-btn" style="width:100%; margin-top: 10px;" disabled>Result Reported</button>`;
                } else if(whatsappAdminNumber){
                    const matchInfoForReport = `Challenge #${match.matchId} (${match.gameType} ${match.matchType})`;
                    const userIgn = (match.players.find(p=>p.uid === user.uid))?.ign || 'N/A';
                    const winMessage = encodeURIComponent(`Admin, I WON ${matchInfoForReport}. My IGN: ${userIgn}. Sending proof.`);
                    const lossMessage = encodeURIComponent(`Admin, I LOST ${matchInfoForReport}. My IGN: ${userIgn}.`);
                    reportActionsHTML = `
                    <p class="instructions" style="margin-top:10px;">Match Finished? Report Your Result:</p>
                    <div style="display: flex; gap: 10px; justify-content: center; margin-top:8px;">
                        <a href="https://wa.me/${whatsappAdminNumber}?text=${winMessage}" target="_blank" class="report-win-btn" onclick="markAsReported('${docId}', '${user.uid}', 'win')">I WON</a>
                        <a href="https://wa.me/${whatsappAdminNumber}?text=${lossMessage}" target="_blank" class="report-loss-btn" onclick="markAsReported('${docId}', '${user.uid}', 'loss')">I LOST</a>
                    </div>`;
                }
            }
            card.innerHTML = `
                <div class="card-top-row"><span>${sanitizeForHTML(match.gameType)}</span><span>${sanitizeForHTML(match.matchType.toUpperCase())}</span><span style="text-transform:capitalize;">${sanitizeForHTML(match.status)}</span></div>
                <h3 class="card-title">By: ${sanitizeForHTML(sanitizeIgnForDisplay(match.creatorIgn))} (#${sanitizeForHTML(match.matchId)})</h3>
                <div class="card-details-grid" style="grid-template-columns: repeat(3, 1fr);">
                    <div class="detail-item"><div class="label">Entry</div><div class="value"><span class="material-icons">monetization_on</span>${match.entryFee}</div></div>
                    <div class="detail-item"><div class="label">Prize</div><div class="value"><span class="material-icons">military_tech</span>${match.prizePool}</div></div>
                    <div class="detail-item"><div class="label">Players</div><div class="value"><span class="material-icons">groups</span>${playersJoined}/${match.numPlayersRequired}</div></div>
                </div>
                ${settingsBlockHTML}
                ${roomDetailsHTML}
                <div class="card-footer">
                    <div class="footer-info">
                    </div>
                    ${actionButtonHTML}
                </div>
                ${creatorActionsHTML}
                ${reportActionsHTML}
            `;
            container.appendChild(card);
        }

        async function joinCustomMatch(event, matchDocId) {
            const user = auth.currentUser; if (!user) { showToast("Login to join.", "error"); return; }
            const matchRef = db.collection(CUSTOM_MATCHES_COLLECTION).doc(matchDocId); const userRef = db.collection('users').doc(user.uid);
            const clickedJoinBtn = event.target; if(clickedJoinBtn) clickedJoinBtn.disabled = true;
            try {
                await db.runTransaction(async (t) => {
                    const matchDoc = await t.get(matchRef); const userAccountDoc = await t.get(userRef);
                    if (!matchDoc.exists) throw "Challenge not found."; if (!userAccountDoc.exists) throw "User account not found.";
                    const matchData = matchDoc.data(); const userData = userAccountDoc.data();
                    const userDisplayName = userData.ign || user.email.split('@')[0];
                    if (matchData.status !== 'open') throw "Challenge not open."; if (matchData.playersArray.includes(user.uid)) throw "Already joined.";
                    if (matchData.players.length >= matchData.numPlayersRequired) throw "Challenge full.";
                    const entryFee = matchData.entryFee; if ((userData.depositWallet || 0) + (userData.winningsWallet || 0) < entryFee) throw "Insufficient balance.";
                    let feeFromDeposit = Math.min(userData.depositWallet || 0, entryFee); let feeFromWinnings = entryFee - feeFromDeposit;
                    t.update(userRef, { depositWallet: firebase.firestore.FieldValue.increment(-feeFromDeposit), winningsWallet: firebase.firestore.FieldValue.increment(-feeFromWinnings) });
                    const newPlayerData = { uid: user.uid, ign: userDisplayName, team: null };
                    const updatedPlayers = [...matchData.players, newPlayerData]; const updatedPlayersArray = [...matchData.playersArray, user.uid];
                    let newStatus = matchData.status; let updatedTeams = matchData.teams;
                    if (matchData.matchType === '2v2') { if (matchData.teams.team1.length < (matchData.numPlayersRequired / 2)) { newPlayerData.team = 1; updatedTeams.team1.push(user.uid); } else if (matchData.teams.team2.length < (matchData.numPlayersRequired / 2)) { newPlayerData.team = 2; updatedTeams.team2.push(user.uid);}}
                    if (updatedPlayers.length === matchData.numPlayersRequired) newStatus = "full";
                    t.update(matchRef, { players: updatedPlayers, playersArray: updatedPlayersArray, status: newStatus, teams: updatedTeams });
                    t.set(db.collection("transactions").doc(), { userId: user.uid, userEmail: user.email, type: "custom_match_fee", amount: entryFee, matchId: matchData.matchId, gameType: matchData.gameType, matchType: matchData.matchType, status: "completed", timestamp: firebase.firestore.FieldValue.serverTimestamp() });
                });
                showToast("Joined challenge! Fee deducted.", "success");
                handleCustomMatchMainTabSwitch('my-custom-matches');
            } catch (error) { console.error("Error joining custom match:", error); showToast("Failed to join: " + (error.message || error), "error"); if(clickedJoinBtn) clickedJoinBtn.disabled = false; }
        }
        async function markAsReported(matchDocId, userId, reportType) {
            const matchRef = db.collection(CUSTOM_MATCHES_COLLECTION).doc(matchDocId);
            try {
                await matchRef.update({
                    [`reports.${userId}`]: { type: reportType, timestamp: firebase.firestore.FieldValue.serverTimestamp() },
                    status: "pending_result",
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                showToast("Result reported to admin!", "success");
            } catch (error) {
                console.error("Error logging report:", error);
                showToast("Could not log report.", "error");
            }
        }
        function openUpdateRoomModal(matchId, currentRoomId, currentRoomPass) {
            document.getElementById('update-room-match-id').value = matchId;
            document.getElementById('update-room-id-input').value = currentRoomId || '';
            document.getElementById('update-room-pass-input').value = currentRoomPass || '';
            document.getElementById('update-room-modal').classList.remove('hidden');
        }
        async function updateChallengeRoomDetails(event) {
            if(event) event.preventDefault();
            const matchId = document.getElementById('update-room-match-id').value;
            const roomId = document.getElementById('update-room-id-input').value.trim();
            const roomPass = document.getElementById('update-room-pass-input').value.trim();
            if (!matchId) { console.error("Match ID missing in updateChallengeRoomDetails"); return; }
            if (!roomId) { showToast("Room ID cannot be empty.", "error"); return; }
            const updateButton = document.querySelector('#update-room-form button');
            if(updateButton) updateButton.disabled = true;
            const currentUser = auth.currentUser;
            if (!currentUser) {
                showToast("You must be logged in.", "error");
                if(updateButton) updateButton.disabled = false;
                return;
            }
            try {
                const matchRef = db.collection(CUSTOM_MATCHES_COLLECTION).doc(matchId);
                const matchDoc = await matchRef.get();
                if (!matchDoc.exists) { throw new Error("Match not found!"); }
                const matchData = matchDoc.data();
                await matchRef.update({ 'roomDetails.id': roomId, 'roomDetails.pass': roomPass, 'status': 'active' });
                showToast("Room details updated & match set to active!", "success");
                document.getElementById('update-room-modal').classList.add('hidden');
                const creatorId = currentUser.uid;
                const otherPlayerIds = (matchData.playersArray || []).filter(id => id !== creatorId);
                if(otherPlayerIds.length > 0) {
                    const notificationMessage = `Room for Challenge #${matchData.matchId} is ready! Room ID: ${roomId}`;
                    const notificationPromises = otherPlayerIds.map(playerId => {
                        const playerNotificationRef = db.collection('users').doc(playerId).collection('notifications');
                        return playerNotificationRef.add({
                            message: notificationMessage, read: false,
                            timestamp: firebase.firestore.FieldValue.serverTimestamp(), type: 'success'
                        });
                    });
                    await Promise.all(notificationPromises);
                    console.log("Notifications sent to other players for room update.");
                }
                if (whatsappAdminNumber) {
                    const userDoc = await db.collection('users').doc(creatorId).get();
                    const userData = userDoc.exists() ? userDoc.data() : {};
                    const allPlayerNames = (matchData.players || []).map(p => sanitizeIgnForDisplay(p.ign)).join(', ');
                    const adminMessage = `
* Match Room Created/Updated!*

Admin, a player has set/updated the room for a challenge.

*Match Info:*
- *Match ID:* ${matchData.matchId || 'N/A'}
- *Game:* ${matchData.gameType || 'N/A'}
- *Type:* ${matchData.matchType || 'N/A'}
- *Players:* ${allPlayerNames || 'N/A'}

*Creator's Info:*
- *User Name:* ${sanitizeIgnForDisplay(userData.ign || 'N/A')}
- *User Email:* ${userData.email || 'N/A'}

*Room Details:*
- *Room ID:* ${roomId}
- *Password:* ${roomPass || 'None'}

This is an automated notification.`.trim();
                    const whatsappURL = `https://wa.me/${whatsappAdminNumber}?text=${encodeURIComponent(adminMessage)}`;
                    window.open(whatsappURL, '_blank');
                    console.log("WhatsApp notification for admin opened.");
                }
            } catch (error) {
                console.error("Error updating room details and notifying admin:", error);
                showToast("Failed to update: " + error.message, "error");
            } finally {
                if(updateButton) updateButton.disabled = false;
            }
        }
        function loadLeaderboard() {
            if (leaderboardListener) { leaderboardListener(); leaderboardListener = null; }
            const container = document.querySelector("#leaderboard-page .leaderboard-list"); if (!container) return;
            renderSkeletonCard(container, 10);
            leaderboardListener = db.collection("users").orderBy("totalWinnings", "desc").limit(100)
                .onSnapshot(snapshot => {
                    if (!container) return;
                    container.innerHTML = ""; if (snapshot.empty) { container.innerHTML = `<p style="text-align:center;padding:15px;">Leaderboard empty.</p>`; return; }
                    let rank = 1; snapshot.forEach(doc => { 
                        const user = doc.data(); 
                        const primaryIgn = sanitizeIgnForDisplay(user.ign || user.email.split('@')[0]);
                        const winnings = user.totalWinnings || 0;
                        const badgeHTML = user.badgeUrl ? `<img src="${user.badgeUrl}" class="user-badge" alt="Badge">` : '';
                        const item = document.createElement('div'); 
                        item.className = 'leaderboard-item';
                        item.innerHTML = `
                            <div class="rank">#${rank}</div>
                            <img src="${user.profilePicUrl || DEFAULT_PROFILE_PIC_URL}" alt="${primaryIgn}" class="profile-pic-small">
                            <div class="info">
                                <div class="name-line">
                                    <span class="name">${primaryIgn}</span>
                                    ${badgeHTML}
                                </div>
                                <div class="winnings-text">${winnings.toFixed(2)} Total Winnings</div>
                            </div>
                            <div class="winnings-value">
                                <span class="material-icons">monetization_on</span>${winnings.toFixed(2)}
                            </div>`;
                        item.querySelector('.profile-pic-small').onclick = () => openUserInspectModal(doc.id);
                        item.querySelector('.info').onclick = () => openUserInspectModal(doc.id);
                        container.appendChild(item); rank++;
                    });
                }, err => { console.error("Error loading leaderboard:", err); if (container) container.innerHTML = `<p style="text-align:center;padding:15px;color:var(--accent-red);">Could not load leaderboard.</p>`;});
        }
        function setupInspectModalListeners() {
            document.getElementById('inspect-like-btn')?.addEventListener('click', async () => {
                if (!currentlyInspectingUserId || !auth.currentUser || auth.currentUser.uid === currentlyInspectingUserId) return;
                const likeBtn = document.getElementById('inspect-like-btn'); const likeBtnTextSpan = likeBtn.querySelector('span:last-child');
                const originalBtnText = likeBtnTextSpan.textContent; likeBtn.disabled = true; likeBtnTextSpan.textContent = "Liking...";
                const result = await likeProfile(currentlyInspectingUserId);
                if (result.success) {
                    const userDoc = await db.collection('users').doc(currentlyInspectingUserId).get();
                    if (userDoc.exists) {
                        const userData = userDoc.data(); const likedByDetailsMap = userData.likedByDetails || {};
                        document.getElementById('inspect-profile-likes').querySelector('span:last-child').textContent = `${Object.keys(likedByDetailsMap).length} Likes`;
                        likeBtnTextSpan.textContent = "Liked";
                    }
                } else {
                    if (!result.message.includes("You can like again in")) { likeBtnTextSpan.textContent = originalBtnText; likeBtn.disabled = false; }
                    else { likeBtnTextSpan.textContent = "Liked"; }
                }
            });
            document.getElementById('inspect-view-full-profile-btn')?.addEventListener('click', () => {
                if (!currentlyInspectingUserId || !auth.currentUser) return;
                loadPageContent('profile-page', auth.currentUser, currentlyInspectingUserId);
                document.getElementById('user-inspect-modal')?.classList.add('hidden');
            });
        }
        async function openUserInspectModal(targetUserId) {
            currentlyInspectingUserId = targetUserId;
            const modal = document.getElementById('user-inspect-modal');
            if (!modal) return;
            const picEl = document.getElementById('inspect-profile-pic');
            const nameEl = document.getElementById('inspect-profile-name'); const bioEl = document.getElementById('inspect-profile-bio');
            const likesCountSpan = document.getElementById('inspect-profile-likes').querySelector('span:last-child');
            const likeBtn = document.getElementById('inspect-like-btn'); const likeBtnTextSpan = likeBtn.querySelector('span:last-child');
            likeBtn.disabled = true; likeBtnTextSpan.textContent = "Like";
            if (auth.currentUser && auth.currentUser.uid === targetUserId) { likeBtn.style.display = 'none'; }
            else { likeBtn.style.display = 'block';}
            try {
                const userDoc = await db.collection('users').doc(targetUserId).get();
                if (userDoc.exists) {
                    const userData = userDoc.data(); 
                    const sanitizedIgn = sanitizeIgnForDisplay(userData.ign || "User");
                    const badgeHTML = userData.badgeUrl ? `<img src="${userData.badgeUrl}" class="user-badge" alt="Badge">` : '';
                    picEl.src = userData.profilePicUrl || DEFAULT_PROFILE_PIC_URL;
                    nameEl.innerHTML = `${sanitizedIgn} ${badgeHTML}`;
                    bioEl.textContent = userData.bio || "No bio set.";
                    const likedByDetailsMap = userData.likedByDetails || {}; const totalLikes = Object.keys(likedByDetailsMap).length;
                    likesCountSpan.textContent = `${totalLikes} Likes`;
                    if (auth.currentUser && auth.currentUser.uid !== targetUserId) {
                        const likerEntry = likedByDetailsMap[auth.currentUser.uid];
                        if (likerEntry && likerEntry.lastLikedAt) {
                            const lastLikedDate = likerEntry.lastLikedAt.toDate(); const now = new Date();
                            if ((now.getTime() - lastLikedDate.getTime()) < (24 * 60 * 60 * 1000)) { likeBtnTextSpan.textContent = "Liked"; likeBtn.disabled = true; }
                            else { likeBtnTextSpan.textContent = "Like"; likeBtn.disabled = false; }
                        } else { likeBtnTextSpan.textContent = "Like"; likeBtn.disabled = false; }
                    } else { likeBtn.disabled = true; }
                } else { nameEl.textContent = "User not found"; likesCountSpan.textContent = "0 Likes"; likeBtn.disabled = true; }
            } catch (error) { console.error("Error fetching user for inspect:", error); nameEl.textContent = "Error"; likeBtn.disabled = true;}
            modal.classList.remove('hidden');
        }
        async function likeProfile(targetUserId) {
            const currentUser = auth.currentUser; if (!currentUser || currentUser.uid === targetUserId) return { success: false, message: "Cannot like yourself or not logged in." };
            const targetUserRef = db.collection('users').doc(targetUserId); const likerUid = currentUser.uid;
            try {
                await db.runTransaction(async (t) => {
                    const targetUserDoc = await t.get(targetUserRef); if (!targetUserDoc.exists) throw new Error("Target user not found.");
                    const targetUserData = targetUserDoc.data(); const likedByDetails = targetUserData.likedByDetails || {};
                    const twentyFourHoursInMillis = 24 * 60 * 60 * 1000; const now = new Date(); const nowTimestamp = firebase.firestore.Timestamp.fromDate(now);
                    if (likedByDetails[likerUid] && likedByDetails[likerUid].lastLikedAt) {
                        const lastLikedDate = likedByDetails[likerUid].lastLikedAt.toDate();
                        if ((now.getTime() - lastLikedDate.getTime()) < twentyFourHoursInMillis) {
                            const timeLeft = twentyFourHoursInMillis - (now.getTime() - lastLikedDate.getTime()); const hL = Math.floor(timeLeft/(1000*60*60)); const mL = Math.floor((timeLeft%(1000*60*60))/(1000*60));
                            throw new Error(`You can like again in ${hL}h ${mL}m.`);
                        }
                    }
                    t.update(targetUserRef, { [`likedByDetails.${likerUid}`]: { lastLikedAt: nowTimestamp } });
                });
                showToast("Profile Liked!", "success"); return { success: true, message: "Profile Liked!" };
            } catch (error) { console.error("Error liking profile:", error); showToast(error.message || "Failed to like profile.", "error"); return { success: false, message: error.message || "Failed to like profile." };}
        }
        function clearAllCountdowns() { activeCountdownIntervals.forEach(id => clearInterval(id)); activeCountdownIntervals = []; }
        function startCountdownTimer(elementId, targetTimestamp) {
            const el = document.getElementById(elementId); if (!el) return;
            const intervalId = setInterval(() => {
                const now = new Date().getTime(); const distance = targetTimestamp - now;
                if (distance < 0) { clearInterval(intervalId); el.innerHTML = "Match Started or Time Passed!"; return; }
                const d = Math.floor(distance/(1000*60*60*24)); const h = Math.floor((distance%(1000*60*60*24))/(1000*60*60)); const m = Math.floor((distance%(1000*60*60))/(1000*60)); const s = Math.floor((distance%(1000*60))/1000);
                el.innerHTML = `Starts in: <strong style="color:var(--accent-green);">${d>0?d+"d ":""}${h}h ${m}m ${s}s</strong>`;
            }, 1000); activeCountdownIntervals.push(intervalId);
        }
        function updateRulesModalWhatsAppLink() {
           const rulesWhatsappLink = document.getElementById('rules-whatsapp-hacker-report');
           if (rulesWhatsappLink && whatsappAdminNumber) {
               const prefillText = encodeURIComponent("Hello Admin, I want to report a suspected hacker. Match ID: [Enter Match ID], Suspect IGN: [Enter Suspect IGN]. I have video proof.");
               rulesWhatsappLink.href = `https://wa.me/${whatsappAdminNumber}?text=${prefillText}`;
           } else if (rulesWhatsappLink) { rulesWhatsappLink.href = "#"; rulesWhatsappLink.onclick = (e) => { e.preventDefault(); showToast("Admin contact not available.", "error"); }}
        }

        async function processMatchResults(matchId) {
            console.log(`Processing results for match: ${matchId}`);
            const matchRef = db.collection("tournaments").doc(matchId);
            
            try {
                const matchDoc = await matchRef.get();
                if (!matchDoc.exists) {
                    console.error("Match not found!");
                    return;
                }
                
                const tourney = matchDoc.data();
                if (!tourney.results || Object.keys(tourney.results).length === 0) {
                    console.error("Match has no 'results' object/map. Please add results to the match document first.");
                    showToast("Error: No results found in the match document.", "error");
                    return;
                }

                const batch = db.batch();

                for (const userId of tourney.participants) {
                    const userRef = db.collection("users").doc(userId);
                    const userResult = tourney.results[userId];

                    if (userResult) {
                        const winnings = userResult.winnings || 0;
                        
                        const historyEntry = {
                            matchId: matchId,
                            title: tourney.title,
                            won: winnings > 0,
                            kills: userResult.kills || 0,
                            winnings: winnings,
                            timestamp: firebase.firestore.FieldValue.serverTimestamp()
                        };

                        batch.update(userRef, {
                            winningsWallet: firebase.firestore.FieldValue.increment(winnings),
                            totalWinnings: firebase.firestore.FieldValue.increment(winnings),
                            matchHistory: firebase.firestore.FieldValue.arrayUnion(historyEntry)
                        });
                    }
                }

                batch.update(matchRef, { status: "results" });

                await batch.commit();
                console.log(`Successfully processed results for match: ${matchId}`);
                showToast("Match results have been processed!", "success");

            } catch (error) {
                console.error("Error processing match results:", error);
                showToast("Error processing results.", "error");
            }
        }
    </script>
</body>
</html>